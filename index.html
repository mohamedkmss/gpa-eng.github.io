<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مسارك الهندسي: حاسبة المعدل الذكية</title>
    
    <!-- Scripts & Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

    <!-- Google Fonts: Noto Sans Arabic for a modern, Google-like UI -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-main: #f8f9fa; --card-bg: #ffffff; --card-border: #e0e0e0; --text-primary: #1f1f1f; --text-secondary: #5f6368; --input-bg: #f1f3f4; --accent-color: #0b57d0; --accent-color-dark: #0a4cb6; --shadow-color: rgba(0, 0, 0, 0.08); --danger-color: #d93025; --danger-color-hover: #b0261d;
        }
        .dark {
            --bg-main: #1f1f1f; --card-bg: #2d2d2d; --card-border: #4a4a4a; --text-primary: #e8eaed; --text-secondary: #9aa0a6; --input-bg: #3c4043; --accent-color: #a8c7fa; --accent-color-dark: #c3d8fb; --shadow-color: rgba(0, 0, 0, 0.4); --danger-color: #f28b82; --danger-color-hover: #ee675d;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-15px); max-height: 0; } to { opacity: 1; transform: translateY(0); max-height: 500px; } }
        @keyframes fadeOut { to { opacity: 0; transform: scale(0.9); max-height: 0; padding-top: 0; padding-bottom: 0; margin-top: 0; margin-bottom: 0; border-width: 0; } }
        html { scroll-behavior: smooth; }
        body { font-family: 'Noto Sans Arabic', sans-serif; background-color: var(--bg-main); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        .card { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 1.5rem; box-shadow: 0 4px 16px var(--shadow-color); transition: all 0.3s; animation: fadeIn 0.5s ease-out forwards; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.6rem; padding: 0.75rem 1.5rem; border-radius: 1.5rem; font-weight: 600; transition: all 0.2s; cursor: pointer; border: none; }
        .btn:focus-visible { outline: 2px solid var(--accent-color); outline-offset: 2px; }
        .btn-primary { background-color: var(--accent-color); color: var(--bg-main); }
        .dark .btn-primary { color: #001d35; }
        .btn-primary:hover { background-color: var(--accent-color-dark); box-shadow: 0 2px 8px rgba(0,0,0,0.15); transform: translateY(-1px); }
        .btn-secondary { background-color: var(--input-bg); color: var(--text-primary); }
        .btn-secondary:hover { background-color: color-mix(in srgb, var(--card-border) 40%, transparent); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: var(--danger-color-hover); }
        .form-input, .form-select { background-color: var(--input-bg); border: 2px solid transparent; color: var(--text-primary); transition: all 0.2s; border-radius: 0.75rem; padding: 0.75rem; width: 100%; -webkit-appearance: none; appearance: none; }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: left 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-left: 2.5rem;
        }
        .dark .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239aa0a6' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }
        .form-input::placeholder { color: var(--text-secondary); opacity: 0.8; }
        .form-input:focus, .form-select:focus { border-color: var(--accent-color); background-color: var(--card-bg); outline: none; box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-color) 20%, transparent); }
        .form-input.input-invalid, .form-select.input-invalid { border-color: var(--danger-color); }
        .course-row, .plan-course-row { transition: all 0.4s ease-in-out, background-color 0.5s; animation: slideIn 0.5s forwards; overflow: hidden; }
        .highlight-row { background-color: color-mix(in srgb, var(--accent-color) 8%, transparent); }
        .modal-overlay { transition: opacity 0.3s; opacity: 0; pointer-events: none; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-content { animation: popIn 0.3s ease-out forwards; max-height: 90vh; overflow-y: auto;}
        .tab { position: relative; cursor: pointer; padding: 0.75rem 1rem; border-bottom: 3px solid transparent; color: var(--text-secondary); font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; transition: color 0.2s, background-color 0.2s; border-radius: 0.5rem 0.5rem 0 0; }
        .tab:hover { color: var(--text-primary); background-color: var(--input-bg); }
        .tab-active { color: var(--accent-color); }
        .dark .tab-active { color: var(--accent-color); }
        .tab-active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 3px; background-color: var(--accent-color); border-radius: 3px; }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        /* Styles for the element that will be captured for export */
        #result-to-capture { background-color: #ffffff; color: #000000; padding: 2rem; font-family: 'Noto Sans Arabic', sans-serif; }
        .transcript-header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 1rem; margin-bottom: 1.5rem; }
        .transcript-table { width: 100%; border-collapse: collapse; font-size: 1rem; }
        .transcript-table th, .transcript-table td { border: 1px solid #ccc; padding: 0.75rem; text-align: center; }
        .transcript-table th { background-color: #f3f4f6; font-weight: bold; }
        .status-badge { padding: 0.2rem 0.6rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .status-new { background-color: #e8f0fe; color: #1967d2; }
        .status-retaken { background-color: #fef7e0; color: #b06000; }
        .help-section { background-color: var(--input-bg); padding: 1.25rem; border-radius: 1rem; }
        .help-section h3 { font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;}
        .help-section p, .help-section li { color: var(--text-secondary); }
        .help-section strong { color: var(--text-primary); }
        .chat-bubble { padding: 0.75rem 1rem; border-radius: 1.25rem; line-height: 1.6; max-width: 100%; word-wrap: break-word; }
        .chat-bubble ul { list-style-type: disc; padding-right: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .loading-dots span { height: 8px; width: 8px; background-color: var(--text-secondary); border-radius: 50%; display: inline-block; animation: wave 1.3s infinite; }
        .loading-dots span:nth-of-type(2) { animation-delay: -1.1s; }
        .loading-dots span:nth-of-type(3) { animation-delay: -0.9s; }
        @keyframes wave { 0%, 60%, 100% { transform: initial; } 30% { transform: translateY(-8px); } }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 3rem 1rem; opacity: 0.6; }
        .status-toggle-group { display: flex; background-color: var(--input-bg); border-radius: 0.75rem; padding: 0.25rem; border: 1px solid var(--card-border); }
        .btn-status { flex-grow: 1; padding: 0.5rem; border-radius: 0.6rem; border: none; background-color: transparent; color: var(--text-secondary); font-weight: 600; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-status.active { background-color: var(--card-bg); color: var(--text-primary); font-weight: 700; box-shadow: 0 1px 2px rgba(0,0,0,0.05), 0 2px 8px rgba(0,0,0,0.05); }
        @media (max-width: 768px) {
            .card { border-radius: 1rem; padding: 1.25rem; }
            .modal-content { width: calc(100% - 2rem); }
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        
        <header class="text-center mb-8 relative">
             <div class="flex justify-center items-center mb-4">
                <img src="./uob-logo.png" alt="شعار جامعة بنغازي" class="w-24 h-24 object-contain">
             </div>
            <h1 class="text-3xl md:text-4xl font-bold">مسارك الهندسي</h1>
            <p class="text-lg mt-2" style="color: var(--text-secondary);">حاسبة المعدل والمرشد الذكي لطلاب الهندسة - جامعة بنغازي</p>
            <div class="absolute top-0 left-0">
                <button id="theme-toggle" class="btn btn-secondary p-3 rounded-full !gap-0" aria-label="تبديل الوضع الليلي">
                    <i data-feather="sun" id="theme-icon-light"></i>
                    <i data-feather="moon" id="theme-icon-dark"></i>
                </button>
            </div>
        </header>

        <main class="card p-6 md:p-10">
            <!-- Tabs -->
            <nav class="flex flex-wrap border-b mb-8" style="border-color: var(--card-border);">
                <a id="tab-calculator" class="tab tab-active" onclick="switchTab('calculator')"><i data-feather="plus-circle"></i> حساب الفصل</a>
                <a id="tab-simulation" class="tab" onclick="switchTab('simulation')"><i data-feather="trending-up"></i> التخطيط للمستقبل</a>
                <a id="tab-advisor" class="tab" onclick="switchTab('advisor')"><i data-feather="message-circle"></i> المرشد الذكي</a>
                <a id="tab-dashboard" class="tab" onclick="switchTab('dashboard')"><i data-feather="bar-chart-2"></i> لوحة التحكم</a>
                <a id="tab-help" class="tab" onclick="switchTab('help')"><i data-feather="help-circle"></i> مساعدة</a>
            </nav>

            <!-- Calculator Content -->
            <div id="content-calculator" class="tab-content active">
                <section class="space-y-10">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 border-r-4 pr-4" style="border-color: var(--accent-color);">الخطوة 1: بياناتك الحالية</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="prev_gpa" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">معدلك التراكمي الحالي (المعدل العام)</label>
                                <input type="number" id="prev_gpa" step="0.001" min="0" max="4" placeholder="مثال: 3.250" class="form-input text-lg">
                            </div>
                            <div>
                                <label for="prev_units" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">عدد الساعات الإجمالية</label>
                                <input type="number" id="prev_units" min="0" placeholder="مثال: 120" class="form-input text-lg">
                            </div>
                        </div>
                        <p class="text-xs mt-3 p-2 rounded-md" style="color: var(--text-secondary); background-color: var(--input-bg);">
                            <strong>ملاحظة:</strong> أدخل 0 إذا كنت طالب فصل أول. يمكنك إيجاد هذه البيانات في آخر استمارة درجات.
                        </p>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-2 border-r-4 pr-4" style="border-color: var(--accent-color);">الخطوة 2: مواد هذا الفصل</h2>
                        <p class="text-sm mb-4" style="color: var(--text-secondary);">
                            أضف موادك وحدد حالتها. إذا كانت "معادة"، سيظهر حقل لإدخال تقديرك القديم.
                        </p>
                        <div id="courses_container" class="space-y-4"></div>
                        <div class="mt-4">
                            <button onclick="addCourse()" class="btn btn-secondary">
                                <i data-feather="plus"></i> إضافة مادة
                            </button>
                        </div>
                    </div>
                    <div class="text-center border-t pt-8 mt-8" style="border-color: var(--card-border);">
                        <button onclick="calculateGPA()" class="btn btn-primary text-xl px-16 py-4">
                            <i data-feather="bar-chart"></i> احسب المعدل
                        </button>
                    </div>
                </section>
            </div>
            
            <!-- Simulation Content -->
            <div id="content-simulation" class="tab-content">
                 <div class="space-y-8">
                    <!-- Target GPA Simulation -->
                    <section>
                        <h2 class="text-2xl font-bold mb-4 border-r-4 pr-4" style="border-color: var(--accent-color);">محاكاة الوصول لهدفك</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                           <div>
                                <label for="sim_current_gpa" class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">معدلك التراكمي الحالي</label>
                                <input type="number" id="sim_current_gpa" step="0.001" min="0" max="4" placeholder="أدخل معدلك الحالي" class="form-input">
                            </div>
                            <div>
                                <label for="sim_current_units" class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">عدد الساعات الإجمالية</label>
                                <input type="number" id="sim_current_units" min="0" placeholder="أدخل وحداتك الإجمالية" class="form-input">
                            </div>
                            <div>
                                <label for="sim_target_gpa" class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">المعدل الذي تطمح إليه</label>
                                <input type="number" id="sim_target_gpa" step="0.001" min="0" max="4" placeholder="مثال: 3.500" class="form-input">
                            </div>
                            <div>
                                <label for="sim_future_units" class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">كم عدد الوحدات القادمة؟</label>
                                <input type="number" id="sim_future_units" min="1" placeholder="مثال: 18" class="form-input">
                            </div>
                        </div>
                        <div class="text-center">
                            <button onclick="runSimulation()" class="btn btn-secondary"><i data-feather="activity"></i> حلّل هدفي</button>
                        </div>
                        <div id="simulation_result" class="text-center p-6 rounded-lg hidden mt-6" style="background-color: var(--input-bg);"></div>
                    </section>
                    
                    <!-- AI Study Plan Generator -->
                    <section class="border-t pt-8" style="border-color: var(--card-border);">
                        <h2 class="text-2xl font-bold mb-4 border-r-4 pr-4" style="border-color: var(--accent-color);">إنشاء خطة دراسية بالذكاء الاصطناعي</h2>
                        <p class="mb-4" style="color: var(--text-secondary);">أدخل موادك للفصل القادم وسيقوم المرشد الذكي بإنشاء خطة دراسية مخصصة لمساعدتك على تحقيق أفضل النتائج.</p>
                        <div id="plan_courses_container" class="space-y-4"></div>
                        <div class="mt-4 flex gap-4">
                            <button onclick="addPlanCourse()" class="btn btn-secondary">
                                <i data-feather="plus"></i> إضافة مادة للخطة
                            </button>
                        </div>
                         <div class="text-center border-t pt-8 mt-8" style="border-color: var(--card-border);">
                            <button onclick="generateStudyPlan()" class="btn btn-primary"><i data-feather="cpu"></i> أنشئ الخطة الآن</button>
                        </div>
                        <div id="study_plan_result" class="p-6 rounded-lg hidden mt-6" style="background-color: var(--input-bg);"></div>
                    </section>
                 </div>
            </div>

            <!-- AI Advisor Content -->
            <div id="content-advisor" class="tab-content">
                <section>
                    <h2 class="text-2xl font-bold mb-4">المرشد الأكاديمي الذكي</h2>
                    <div id="chat-container" class="h-[500px] flex flex-col rounded-lg overflow-hidden border" style="background-color: var(--input-bg); border-color: var(--card-border);">
                        <div id="chat-messages" class="flex-grow p-4 overflow-y-auto flex flex-col gap-4">
                            <!-- Messages are appended here -->
                        </div>
                        <form id="chat-form" class="p-2 flex gap-2 border-t" style="border-color: var(--card-border);">
                            <input type="text" id="chat-input" placeholder="اكتب سؤالك هنا..." class="form-input w-full !rounded-full" autocomplete="off">
                            <button type="submit" id="send-button" class="btn btn-primary !rounded-full !p-3 !gap-0" aria-label="إرسال الرسالة">
                                <i data-feather="send"></i>
                            </button>
                        </form>
                    </div>
                </section>
            </div>

            <!-- Dashboard Content -->
            <div id="content-dashboard" class="tab-content">
                <section>
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">لوحة التحكم</h2>
                        <div class="flex gap-2">
                            <button onclick="exportResults()" class="btn btn-secondary"><i data-feather="download"></i> تصدير</button>
                            <button onclick="document.getElementById('import-input').click()" class="btn btn-secondary"><i data-feather="upload"></i> استيراد</button>
                            <input type="file" id="import-input" class="hidden" accept=".json" onchange="importResults(event)">
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="p-4 rounded-xl" style="background-color: var(--input-bg);">
                            <h3 class="font-bold mb-4">تطور المعدل التراكمي</h3>
                            <div class="h-64"><canvas id="gpa-chart"></canvas></div>
                        </div>
                        <h3 class="font-bold text-xl pt-4 border-t" style="border-color: var(--card-border);">النتائج المحفوظة</h3>
                        <div id="saved