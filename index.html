<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مسارك الهندسي: حاسبة المعدل الذكية</title>
    
    <!-- Scripts & Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

    <!-- Google Fonts: Noto Sans Arabic for a modern, Google-like UI -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-main: #f8f9fa; --card-bg: #ffffff; --card-border: #e0e0e0; --text-primary: #1f1f1f; --text-secondary: #5f6368; --input-bg: #f1f3f4; --accent-color: #0b57d0; --accent-color-dark: #0a4cb6; --shadow-color: rgba(0, 0, 0, 0.08); --danger-color: #d93025; --danger-color-hover: #b0261d;
        }
        .dark {
            --bg-main: #1f1f1f; --card-bg: #2d2d2d; --card-border: #4a4a4a; --text-primary: #e8eaed; --text-secondary: #9aa0a6; --input-bg: #3c4043; --accent-color: #a8c7fa; --accent-color-dark: #c3d8fb; --shadow-color: rgba(0, 0, 0, 0.4); --danger-color: #f28b82; --danger-color-hover: #ee675d;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-15px); max-height: 0; } to { opacity: 1; transform: translateY(0); max-height: 500px; } }
        @keyframes fadeOut { to { opacity: 0; transform: scale(0.9); max-height: 0; padding-top: 0; padding-bottom: 0; margin-top: 0; margin-bottom: 0; border-width: 0; } }
        html { scroll-behavior: smooth; }
        body { font-family: 'Noto Sans Arabic', sans-serif; background-color: var(--bg-main); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        .card { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 1.5rem; box-shadow: 0 4px 16px var(--shadow-color); transition: all 0.3s; animation: fadeIn 0.5s ease-out forwards; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.6rem; padding: 0.75rem 1.5rem; border-radius: 1.5rem; font-weight: 600; transition: all 0.2s; cursor: pointer; border: none; }
        .btn:focus-visible { outline: 2px solid var(--accent-color); outline-offset: 2px; }
        .btn-primary { background-color: var(--accent-color); color: var(--bg-main); }
        .dark .btn-primary { color: #001d35; }
        .btn-primary:hover { background-color: var(--accent-color-dark); box-shadow: 0 2px 8px rgba(0,0,0,0.15); transform: translateY(-1px); }
        .btn-secondary { background-color: var(--input-bg); color: var(--text-primary); }
        .btn-secondary:hover { background-color: color-mix(in srgb, var(--card-border) 40%, transparent); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: var(--danger-color-hover); }
        .form-input, .form-select { background-color: var(--input-bg); border: 2px solid transparent; color: var(--text-primary); transition: all 0.2s; border-radius: 0.75rem; padding: 0.75rem; width: 100%; -webkit-appearance: none; appearance: none; }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: left 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-left: 2.5rem;
        }
        .dark .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239aa0a6' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }
        .form-input::placeholder { color: var(--text-secondary); opacity: 0.8; }
        .form-input:focus, .form-select:focus { border-color: var(--accent-color); background-color: var(--card-bg); outline: none; box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-color) 20%, transparent); }
        .form-input.input-invalid, .form-select.input-invalid { border-color: var(--danger-color); }
        .course-row, .plan-course-row { transition: all 0.4s ease-in-out, background-color 0.5s; animation: slideIn 0.5s forwards; overflow: hidden; }
        .highlight-row { background-color: color-mix(in srgb, var(--accent-color) 8%, transparent); }
        .modal-overlay { transition: opacity 0.3s; opacity: 0; pointer-events: none; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-content { animation: popIn 0.3s ease-out forwards; max-height: 90vh; overflow-y: auto;}
        .tab { position: relative; cursor: pointer; padding: 0.75rem 1rem; border-bottom: 3px solid transparent; color: var(--text-secondary); font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; transition: color 0.2s, background-color 0.2s; border-radius: 0.5rem 0.5rem 0 0; }
        .tab:hover { color: var(--text-primary); background-color: var(--input-bg); }
        .tab-active { color: var(--accent-color); }
        .dark .tab-active { color: var(--accent-color); }
        .tab-active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 3px; background-color: var(--accent-color); border-radius: 3px; }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        /* Styles for the element that will be captured for export */
        #result-to-capture { background-color: #ffffff; color: #000000; padding: 2rem; font-family: 'Noto Sans Arabic', sans-serif; }
        .transcript-header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 1rem; margin-bottom: 1.5rem; }
        .transcript-table { width: 100%; border-collapse: collapse; font-size: 1rem; }
        .transcript-table th, .transcript-table td { border: 1px solid #ccc; padding: 0.75rem; text-align: center; }
        .transcript-table th { background-color: #f3f4f6; font-weight: bold; }
        .status-badge { padding: 0.2rem 0.6rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .status-new { background-color: #e8f0fe; color: #1967d2; }
        .status-retaken { background-color: #fef7e0; color: #b06000; }
        .help-section { background-color: var(--input-bg); padding: 1.25rem; border-radius: 1rem; }
        .help-section h3 { font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;}
        .help-section p, .help-section li { color: var(--text-secondary); }
        .help-section strong { color: var(--text-primary); }
        .chat-bubble { padding: 0.75rem 1rem; border-radius: 1.25rem; line-height: 1.6; max-width: 100%; word-wrap: break-word; }
        .chat-bubble ul { list-style-type: disc; padding-right: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .loading-dots span { height: 8px; width: 8px; background-color: var(--text-secondary); border-radius: 50%; display: inline-block; animation: wave 1.3s infinite; }
        .loading-dots span:nth-of-type(2) { animation-delay: -1.1s; }
        .loading-dots span:nth-of-type(3) { animation-delay: -0.9s; }
        @keyframes wave { 0%, 60%, 100% { transform: initial; } 30% { transform: translateY(-8px); } }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 3rem 1rem; opacity: 0.6; }
        .status-toggle-group { display: flex; background-color: var(--input-bg); border-radius: 0.75rem; padding: 0.25rem; border: 1px solid var(--card-border); }
        .btn-status { flex-grow: 1; padding: 0.5rem; border-radius: 0.6rem; border: none; background-color: transparent; color: var(--text-secondary); font-weight: 600; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-status.active { background-color: var(--card-bg); color: var(--text-primary); font-weight: 700; box-shadow: 0 1px 2px rgba(0,0,0,0.05), 0 2px 8px rgba(0,0,0,0.05); }
        @media (max-width: 768px) {
            .card { border-radius: 1rem; padding: 1.25rem; }
            .modal-content { width: calc(100% - 2rem); }
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        
        <header class="text-center mb-8 relative">
             <div class="flex justify-center items-center mb-4">
                <img src="./uob-logo.png" alt="شعار جامعة بنغازي" class="w-24 h-24 object-contain">
             </div>
            <h1 class="text-3xl md:text-4xl font-bold">مسارك الهندسي</h1>
            <p class="text-lg mt-2" style="color: var(--text-secondary);">حاسبة المعدل والمرشد الذكي لطلاب الهندسة - جامعة بنغازي</p>
            <div class="absolute top-0 left-0">
                <button id="theme-toggle" class="btn btn-secondary p-3 rounded-full !gap-0" aria-label="تبديل الوضع الليلي">
                    <i data-feather="sun" id="theme-icon-light"></i>
                    <i data-feather="moon" id="theme-icon-dark"></i>
                </button>
            </div>
        </header>

        <main class="card p-6 md:p-10">
            <!-- Tabs -->
            <nav class="flex flex-wrap border-b mb-8" style="border-color: var(--card-border);">
                <a id="tab-calculator" class="tab tab-active" onclick="switchTab('calculator')"><i data-feather="plus-circle"></i> حساب الفصل</a>
                <a id="tab-simulation" class="tab" onclick="switchTab('simulation')"><i data-feather="trending-up"></i> التخطيط للمستقبل</a>
                <a id="tab-advisor" class="tab" onclick="switchTab('advisor')"><i data-feather="message-circle"></i> المرشد الذكي</a>
                <a id="tab-dashboard" class="tab" onclick="switchTab('dashboard')"><i data-feather="bar-chart-2"></i> لوحة التحكم</a>
                <a id="tab-help" class="tab" onclick="switchTab('help')"><i data-feather="help-circle"></i> مساعدة</a>
            </nav>

            <!-- Calculator Content -->
            <div id="content-calculator" class="tab-content active">
                <section class="space-y-10">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 border-r-4 pr-4" style="border-color: var(--accent-color);">الخطوة 1: بياناتك الحالية</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="prev_gpa" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">معدلك التراكمي الحالي (المعدل العام)</label>
                                <input type="number" id="prev_gpa" step="0.001" min="0" max="4" placeholder="مثال: 3.250" class="form-input text-lg">
                            </div>
                            <div>
                                <label for="prev_units" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">عدد الساعات الإجمالية</label>
                                <input type="number" id="prev_units" min="0" placeholder="مثال: 120" class="form-input text-lg">
                            </div>
                        </div>
                        <p class="text-xs mt-3 p-2 rounded-md" style="color: var(--text-secondary); background-color: var(--input-bg);">
                            <strong>ملاحظة:</strong> أدخل 0 إذا كنت طالب فصل أول. يمكنك إيجاد هذه البيانات في آخر استمارة درجات.
                        </p>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-2 border-r-4 pr-4" style="border-color: var(--accent-color);">الخطوة 2: مواد هذا الفصل</h2>
                        <p class="text-sm mb-4" style="color: var(--text-secondary);">
                            أضف موادك وحدد حالتها. إذا كانت "معادة"، سيظهر حقل لإدخال تقديرك القديم.
                        </p>
                        <div id="courses_container" class="space-y-4"></div>
                        <div class="mt-4">
                            <button onclick="addCourse()" class="btn btn-secondary">
                                <i data-feather="plus"></i> إضافة مادة
                            </button>
                        </div>
                    </div>
                    <div class="text-center border-t pt-8 mt-8" style="border-color: var(--card-border);">
                        <button onclick="calculateGPA()" class="btn btn-primary text-xl px-16 py-4">
                            <i data-feather="bar-chart"></i> احسب المعدل
                        </button>
                    </div>
                </section>
            </div>
            
            <!-- Simulation Content -->
            <div id="content-simulation" class="tab-content">
                 <div class="space-y-8">
                    <!-- Target GPA Simulation -->
                    <section>
                        <h2 class="text-2xl font-bold mb-4 border-r-4 pr-4" style="border-color: var(--accent-color);">محاكاة الوصول لهدفك</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                           <div>
                                <label for="sim_current_gpa" class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">معدلك التراكمي الحالي</label>
                                <input type="number" id="sim_current_gpa" step="0.001" min="0" max="4" placeholder="أدخل معدلك الحالي" class="form-input">
                            </div>
                            <div>
                                <label for="sim_current_units" class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">عدد الساعات الإجمالية</label>
                                <input type="number" id="sim_current_units" min="0" placeholder="أدخل وحداتك الإجمالية" class="form-input">
                            </div>
                            <div>
                                <label for="sim_target_gpa" class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">المعدل الذي تطمح إليه</label>
                                <input type="number" id="sim_target_gpa" step="0.001" min="0" max="4" placeholder="مثال: 3.500" class="form-input">
                            </div>
                            <div>
                                <label for="sim_future_units" class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">كم عدد الوحدات القادمة؟</label>
                                <input type="number" id="sim_future_units" min="1" placeholder="مثال: 18" class="form-input">
                            </div>
                        </div>
                        <div class="text-center">
                            <button onclick="runSimulation()" class="btn btn-secondary"><i data-feather="activity"></i> حلّل هدفي</button>
                        </div>
                        <div id="simulation_result" class="text-center p-6 rounded-lg hidden mt-6" style="background-color: var(--input-bg);"></div>
                    </section>
                    
                    <!-- AI Study Plan Generator -->
                    <section class="border-t pt-8" style="border-color: var(--card-border);">
                        <h2 class="text-2xl font-bold mb-4 border-r-4 pr-4" style="border-color: var(--accent-color);">إنشاء خطة دراسية بالذكاء الاصطناعي</h2>
                        <p class="mb-4" style="color: var(--text-secondary);">أدخل موادك للفصل القادم وسيقوم المرشد الذكي بإنشاء خطة دراسية مخصصة لمساعدتك على تحقيق أفضل النتائج.</p>
                        <div id="plan_courses_container" class="space-y-4"></div>
                        <div class="mt-4 flex gap-4">
                            <button onclick="addPlanCourse()" class="btn btn-secondary">
                                <i data-feather="plus"></i> إضافة مادة للخطة
                            </button>
                        </div>
                         <div class="text-center border-t pt-8 mt-8" style="border-color: var(--card-border);">
                            <button onclick="generateStudyPlan()" class="btn btn-primary"><i data-feather="cpu"></i> أنشئ الخطة الآن</button>
                        </div>
                        <div id="study_plan_result" class="p-6 rounded-lg hidden mt-6" style="background-color: var(--input-bg);"></div>
                    </section>
                 </div>
            </div>

            <!-- AI Advisor Content -->
            <div id="content-advisor" class="tab-content">
                <section>
                    <h2 class="text-2xl font-bold mb-4">المرشد الأكاديمي الذكي</h2>
                    <div id="chat-container" class="h-[500px] flex flex-col rounded-lg overflow-hidden border" style="background-color: var(--input-bg); border-color: var(--card-border);">
                        <div id="chat-messages" class="flex-grow p-4 overflow-y-auto flex flex-col gap-4">
                            <!-- Messages are appended here -->
                        </div>
                        <form id="chat-form" class="p-2 flex gap-2 border-t" style="border-color: var(--card-border);">
                            <input type="text" id="chat-input" placeholder="اكتب سؤالك هنا..." class="form-input w-full !rounded-full" autocomplete="off">
                            <button type="submit" id="send-button" class="btn btn-primary !rounded-full !p-3 !gap-0" aria-label="إرسال الرسالة">
                                <i data-feather="send"></i>
                            </button>
                        </form>
                    </div>
                </section>
            </div>

            <!-- Dashboard Content -->
            <div id="content-dashboard" class="tab-content">
                <section>
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">لوحة التحكم</h2>
                        <div class="flex gap-2">
                            <button onclick="exportResults()" class="btn btn-secondary"><i data-feather="download"></i> تصدير</button>
                            <button onclick="document.getElementById('import-input').click()" class="btn btn-secondary"><i data-feather="upload"></i> استيراد</button>
                            <input type="file" id="import-input" class="hidden" accept=".json" onchange="importResults(event)">
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="p-4 rounded-xl" style="background-color: var(--input-bg);">
                            <h3 class="font-bold mb-4">تطور المعدل التراكمي</h3>
                            <div class="h-64"><canvas id="gpa-chart"></canvas></div>
                        </div>
                        <h3 class="font-bold text-xl pt-4 border-t" style="border-color: var(--card-border);">النتائج المحفوظة</h3>
                        <div id="saved-results-container" class="space-y-4"></div>
                        <div id="no-saved-results" class="hidden">
                             <div class="empty-state">
                                <i data-feather="archive" class="w-16 h-16 mb-4"></i>
                                <h4 class="font-bold text-lg">لا توجد نتائج محفوظة</h4>
                                <p style="color: var(--text-secondary);">سيتم عرض النتائج التي تحفظها هنا.</p>
                             </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Help Content -->
            <div id="content-help" class="tab-content">
                <section class="space-y-6">
                     <div class="help-section">
                        <h3><i data-feather="file-text"></i> كيفية قراءة استمارتك</h3>
                        <p class="mb-3">لاستخدام الحاسبة بدقة، تحتاج لإدخال <strong>"المعدل العام"</strong> و <strong>"الساعات الإجمالية"</strong> من استمارتك الجامعية.</p>
                        <div class="flex justify-center p-2 border rounded-lg" style="background-color: var(--card-bg); border-color: var(--card-border);">
                           <img src="./transcript-guide.png" alt="شرح استمارة جامعة بنغازي" class="rounded-md shadow-md max-w-full h-auto">
                        </div>
                    </div>
                     <div class="help-section">
                        <h3><i data-feather="award"></i> نظام التقديرات المعتمد</h3>
                         <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-center text-sm font-mono">
                            <div class="p-2 rounded" style="background-color: var(--card-bg); color: var(--text-primary);">AA = 4.0</div>
                            <div class="p-2 rounded" style="background-color: var(--card-bg); color: var(--text-primary);">A = 3.5</div>
                            <div class="p-2 rounded" style="background-color: var(--card-bg); color: var(--text-primary);">BB = 3.0</div>
                            <div class="p-2 rounded" style="background-color: var(--card-bg); color: var(--text-primary);">B = 2.5</div>
                            <div class="p-2 rounded" style="background-color: var(--card-bg); color: var(--text-primary);">CC = 2.0</div>
                            <div class="p-2 rounded" style="background-color: var(--card-bg); color: var(--text-primary);">C = 1.5</div>
                            <div class="p-2 rounded" style="background-color: var(--card-bg); color: var(--text-primary);">DD = 1.0</div>
                            <div class="p-2 rounded" style="background-color: var(--card-bg); color: var(--text-primary);">D = 0.5</div>
                            <div class="p-2 rounded" style="background-color: var(--card-bg); color: var(--text-primary);">F = 0.0</div>
                        </div>
                    </div>
                    <div class="help-section">
                        <h3><i data-feather="help-circle"></i> أسئلة شائعة</h3>
                        <ul class="list-disc list-inside space-y-3">
                            <li><strong>ماذا أفعل في حالة الرسوب (F)؟</strong><br>عند إعادة المادة وتحصيل تقدير جديد، سيتم إلغاء تأثير التقدير القديم (F) واحتساب التقدير الجديد فقط في المعدل التراكمي. الساعات لا تضاف مرة أخرى.</li>
                            <li><strong>ماذا لو رسبت في مادة اختيارية؟</strong><br>إذا رسبت في مادة اختيارية، يمكنك إعادتها أو دراسة مادة اختيارية أخرى بدلاً عنها. في كلتا الحالتين، تأثير الرسوب القديم سيبقى في المعدل حتى تجتاز مادة اختيارية بنفس عدد الوحدات.</li>
                            <li><strong>كيف يتم التعامل مع المواد المحذوفة (W)؟</strong><br>المواد التي يتم حذفها (Withdrawal) لا تدخل في حساب المعدل التراكمي ولا تؤثر عليه.</li>
                            <li><strong>هل تؤثر علامة "غير مكتمل" (I) على المعدل؟</strong><br>لا، علامة "غير مكتمل" (Incomplete) لا تدخل في حساب المعدل. يجب إكمال متطلبات المادة لتحويلها إلى تقدير نهائي.</li>
                        </ul>
                    </div>
                     <div class="help-section">
                        <h3><i data-feather="info"></i> إرشادات هامة</h3>
                         <ul class="list-disc list-inside space-y-3">
                            <li><strong>للمواد المعادة:</strong> أدخل التقدير القديم بدقة. الحاسبة ستقوم تلقائياً بخصم نقاط التقدير القديم وإضافة نقاط التقدير الجديد، مع الحفاظ على عدد الساعات ثابتاً.</li>
                            <li><strong>دقة البيانات:</strong> تأكد من إدخال معدلك وساعاتك الإجمالية من آخر استمارة صادرة من الكلية لضمان الحصول على نتيجة دقيقة.</li>
                            <li><strong>أداة تقديرية:</strong> تذكر أن هذه الأداة للمساعدة والإرشاد فقط، والنتائج الرسمية هي التي تصدرها الكلية.</li>
                        </ul>
                    </div>
                </section>
            </div>
        </main>
        
        <footer class="text-center mt-8 text-sm" style="color: var(--text-secondary);">
            <p>&copy; <span id="year"></span> - تم التطوير لخدمة طلاب جامعة بنغازي.</p>
        </footer>
    </div>

    <!-- Results Modal -->
    <div id="results_modal" class="fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50">
        <div class="card modal-content p-4 sm:p-6 w-full max-w-3xl relative">
            <button onclick="closeModal('results_modal')" class="absolute top-4 left-4 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" aria-label="إغلاق النافذة">
                <i data-feather="x" class="w-6 h-6" style="color: var(--text-secondary)"></i>
            </button>
            <div id="result-to-capture">
                <!-- Transcript Content will be dynamically generated here -->
            </div>
            <div id="modal-buttons" class="flex flex-wrap justify-center gap-3 mt-6 pt-4 border-t" style="border-color: var(--card-border);">
                <button onclick="saveResult()" class="btn btn-primary"><i data-feather="save"></i> حفظ النتيجة</button>
                <button onclick="shareWebsite()" class="btn btn-secondary"><i data-feather="share-2"></i> مشاركة الموقع</button>
                <button onclick="shareAsImage()" class="btn btn-secondary"><i data-feather="camera"></i> حفظ كصورة</button>
                <button onclick="shareAsPDF()" class="btn btn-secondary"><i data-feather="file-text"></i> حفظ كـ PDF</button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm_modal" class="fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50">
        <div class="card modal-content p-8 w-full max-w-sm text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full" style="background-color: color-mix(in srgb, var(--danger-color) 15%, transparent);"><i data-feather="trash-2" class="w-6 h-6" style="color: var(--danger-color);"></i></div>
            <h3 class="text-lg font-medium leading-6 mt-4" id="confirm_title">حذف النتيجة</h3>
            <div class="mt-2">
                <p class="text-sm" style="color: var(--text-secondary);" id="confirm_message">هل أنت متأكد من رغبتك في حذف هذه النتيجة؟ لا يمكن التراجع عن هذا الإجراء.</p>
            </div>
            <div class="mt-6 flex justify-center gap-4">
                <button id="confirm_button" class="btn btn-danger">تأكيد الحذف</button>
                <button onclick="closeModal('confirm_modal')" class="btn btn-secondary">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 py-3 px-6 rounded-full shadow-xl opacity-0 translate-y-3 transition-all duration-300 z-[100]">
        <p id="toast-message"></p>
    </div>

    <script>
        // --- GLOBAL VARIABLES & INITIALIZATION ---
        let courseCount = 0, planCourseCount = 0, savedResults = [], gpaChart = null, lastCalculationData = {};
        const formState = {};
        
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            setupTheme();
            loadSavedResults();
            addCourse();
            addPlanCourse();
            setupInputValidation();
            document.getElementById('year').textContent = new Date().getFullYear();
            document.getElementById('chat-form').addEventListener('submit', handleSendMessage);
            setupChat();
            
            document.querySelectorAll('.form-input, .form-select').forEach(input => {
                input.addEventListener('change', saveFormState);
            });
        });

        function loadSavedResults() {
             try {
                savedResults = JSON.parse(localStorage.getItem('gpaResults')) || [];
                if (!Array.isArray(savedResults)) {
                    savedResults = [];
                    localStorage.setItem('gpaResults', JSON.stringify([]));
                }
            } catch (e) {
                console.error("Error loading saved results:", e);
                savedResults = [];
                localStorage.setItem('gpaResults', JSON.stringify([]));
            }
        }
        
        function saveFormState() {
            document.querySelectorAll('.form-input, .form-select').forEach(input => {
                if (input.id) formState[input.id] = input.value;
            });
        }
        
        function loadFormState() {
             document.querySelectorAll('.form-input, .form-select').forEach(input => {
                if (input.id && formState[input.id]) {
                    input.value = formState[input.id];
                }
            });
        }

        // --- THEME & UI ---
        function applyTheme(theme) {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            document.getElementById('theme-icon-light').style.display = theme === 'dark' ? 'none' : 'block';
            document.getElementById('theme-icon-dark').style.display = theme === 'dark' ? 'block' : 'none';
            if (gpaChart) {
                setTimeout(() => renderGPATrendChart(), 10);
            }
        }

        function setupTheme() {
            // دالة لتطبيق الثيم الأولي بناءً على تفضيل المستخدم أو إعدادات النظام
            const setInitialTheme = () => {
                const savedTheme = localStorage.getItem('theme');
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (savedTheme) {
                    applyTheme(savedTheme);
                } else {
                    applyTheme(systemPrefersDark ? 'dark' : 'light');
                }
            };

            setInitialTheme();

            // مستمع لتغيرات ثيم النظام
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                // يتم التطبيق فقط إذا لم يقم المستخدم بتحديد ثيم يدويًا
                if (!localStorage.getItem('theme')) {
                    applyTheme(e.matches ? 'dark' : 'light');
                }
            });

            // مستمع لزر تبديل الثيم اليدوي
            document.getElementById('theme-toggle').addEventListener('click', () => {
                const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                // حفظ اختيار المستخدم في الـ localStorage لتجاوز إعدادات النظام
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
            document.getElementById(`content-${tabName}`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
            if (tabName === 'dashboard') loadDashboard();
            loadFormState();
        }

        // --- GPA CALCULATOR ---
        function addCourse() {
            courseCount++;
            const courseRow = document.createElement('div');
            courseRow.id = 'course_' + courseCount;
            courseRow.className = 'course-row p-3 rounded-lg border';
            courseRow.style.borderColor = 'var(--card-border)';
            courseRow.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-12 gap-x-3 gap-y-3 items-center">
                    <!-- Course Name -->
                    <div class="md:col-span-4">
                        <label class="block text-xs font-medium md:hidden mb-1" style="color: var(--text-secondary);">اسم المادة</label>
                        <input type="text" placeholder="اسم المادة" class="form-input p-2 course-name">
                    </div>
                    <!-- Units & Grade (Flex on mobile) -->
                    <div class="md:col-span-4 flex gap-3">
                        <div class="w-1/2">
                            <label class="block text-xs font-medium md:hidden mb-1" style="color: var(--text-secondary);">الوحدات</label>
                            <input type="number" placeholder="الوحدات" min="1" class="form-input p-2 course-units">
                        </div>
                        <div class="w-1/2">
                            <label class="block text-xs font-medium md:hidden mb-1" style="color: var(--text-secondary);">التقدير</label>
                            <select class="form-select p-2 course-grade">${getGradeOptions()}</select>
                        </div>
                    </div>
                    <!-- Status Toggle -->
                    <div class="md:col-span-3">
                        <label class="block text-xs font-medium md:hidden mb-1" style="color: var(--text-secondary);">حالة المادة</label>
                        <div class="status-toggle-group">
                            <button type="button" class="btn-status active" data-value="new" onclick="setCourseType(this, ${courseCount})">جديدة</button>
                            <button type="button" class="btn-status" data-value="retaken" onclick="setCourseType(this, ${courseCount})">معادة</button>
                        </div>
                    </div>
                    <!-- Remove Button -->
                    <div class="md:col-span-1 flex justify-end">
                        <button onclick="removeCourse('course_', ${courseCount})" class="p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/40" aria-label="حذف المادة"><i data-feather="trash-2" class="text-red-500"></i></button>
                    </div>
                    <!-- Old Grade Container (Spans full width) -->
                    <div id="old-grade-container-${courseCount}" class="md:col-span-12 hidden mt-2">
                        <div class="p-3 rounded-md" style="background-color: var(--input-bg);">
                            <label for="old-grade-select-${courseCount}" class="block text-sm text-center font-medium mb-2" style="color:var(--text-secondary)">أدخل التقدير القديم للمادة المعادة</label>
                            <div class="max-w-xs mx-auto">
                                <select id="old-grade-select-${courseCount}" class="form-select p-2 course-old-grade">${getGradeOptions(true)}</select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('courses_container').appendChild(courseRow);
            feather.replace();
            courseRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function setCourseType(btn, courseId) {
            const parent = btn.parentElement;
            parent.querySelector('.btn-status.active').classList.remove('active');
            btn.classList.add('active');
            toggleOldGrade(btn.dataset.value, courseId);
        }

        function removeCourse(prefix, id) {
            const courseRow = document.getElementById(prefix + id);
            if (courseRow) {
                 courseRow.style.animation = 'fadeOut 0.4s forwards';
                 setTimeout(() => courseRow.remove(), 400);
            }
        }

        function toggleOldGrade(courseType, courseId) {
            const row = document.getElementById(`course_${courseId}`);
            const container = document.getElementById(`old-grade-container-${courseId}`);
            if(!row || !container) return;
            
            if (courseType === 'retaken') {
                container.classList.remove('hidden');
                row.classList.add('highlight-row');
                setTimeout(() => row.classList.remove('highlight-row'), 1500);
            } else {
                container.classList.add('hidden');
                row.classList.remove('highlight-row');
            }
        }

        function calculateGPA() {
            if (!validateInputs('#content-calculator')) {
                showToast("يرجى ملء جميع الحقول المطلوبة.", "error");
                return;
            }
            const prevGPA = parseFloat(document.getElementById('prev_gpa').value) || 0;
            const prevUnits = parseInt(document.getElementById('prev_units').value) || 0;
            
            let cumulativePoints = prevGPA * prevUnits;
            let cumulativeUnits = prevUnits;
            let semesterPoints = 0;
            let semesterUnits = 0;
            let courses = [];

            document.querySelectorAll('#courses_container .course-row').forEach(row => {
                const unitsInput = row.querySelector('.course-units');
                const gradeInput = row.querySelector('.course-grade');
                const type = row.querySelector('.btn-status.active').dataset.value;

                if (!unitsInput.value || !gradeInput.value) return;

                const units = parseInt(unitsInput.value);
                const grade = parseFloat(gradeInput.value);
                
                semesterPoints += grade * units;
                semesterUnits += units;

                if (type === 'new') {
                    cumulativePoints += grade * units;
                    cumulativeUnits += units;
                } else { // 'retaken'
                    const oldGradeInput = row.querySelector('.course-old-grade');
                    const oldGrade = parseFloat(oldGradeInput.value);
                    cumulativePoints = cumulativePoints - (oldGrade * units) + (grade * units);
                }
                courses.push({ name: row.querySelector('.course-name').value || 'مادة', units, grade, type });
            });

            const semesterGPA = semesterUnits > 0 ? (semesterPoints / semesterUnits) : 0;
            const cumulativeGPA = cumulativeUnits > 0 ? (cumulativePoints / cumulativeUnits) : 0;
            
            lastCalculationData = { semesterGPA, cumulativeGPA, semesterUnits, cumulativeUnits, courses, prevGPA, prevUnits };
            displayResults(lastCalculationData);
        }

        function displayResults(data) {
            const resultContainer = document.getElementById('result-to-capture');
            const today = new Date().toLocaleDateString('ar-EG-u-nu-latn', { year: 'numeric', month: 'long', day: 'numeric' });
            
            resultContainer.innerHTML = `
                <div class="transcript-header flex justify-between items-center">
                    <img src="./uob-logo.png" alt="شعار الجامعة" class="w-20 h-20 object-contain">
                    <div class="text-center">
                        <h2 class="text-xl sm:text-2xl font-bold">جامعة بنغازي - كلية الهندسة</h2>
                        <p class="text-md sm:text-lg">كشف درجات تقديري</p>
                        <p class="text-sm" style="color: #5f6368;">تاريخ الإصدار: ${today}</p>
                    </div>
                    <div class="w-20"></div>
                </div>
                <div class="overflow-x-auto">
                    <table class="transcript-table">
                        <thead><tr><th>اسم المادة</th><th>الحالة</th><th>الوحدات</th><th>التقدير</th><th>النقاط</th></tr></thead>
                        <tbody>${data.courses.map(c => `<tr><td>${c.name}</td><td><span class="status-badge ${c.type === 'retaken' ? 'status-retaken' : 'status-new'}">${c.type === 'retaken' ? 'معادة' : 'جديدة'}</span></td><td>${c.units}</td><td><span style="direction: ltr; display: inline-block; width: 100%;">${getGradeText(c.grade)} (${c.grade.toFixed(1)})</span></td><td>${(c.units * c.grade).toFixed(2)}</td></tr>`).join('')}</tbody>
                    </table>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mt-6 pt-6 border-t">
                    <div class="text-center"><p class="text-sm font-semibold">المعدل الفصلي</p><p class="text-xl font-bold text-blue-600">${data.semesterGPA.toFixed(3)}</p></div>
                    <div class="text-center"><p class="text-sm font-semibold">المعدل التراكمي</p><p class="text-xl font-bold text-green-600">${data.cumulativeGPA.toFixed(3)}</p></div>
                    <div class="text-center"><p class="text-sm font-semibold">وحدات الفصل</p><p class="text-xl font-bold">${data.semesterUnits}</p></div>
                    <div class="text-center"><p class="text-sm font-semibold">مجموع الساعات</p><p class="text-xl font-bold">${data.cumulativeUnits}</p></div>
                </div>
                <div class="mt-6 p-4 rounded-lg" style="background-color: #f1f3f4;">
                    <h4 class="font-bold flex items-center gap-2"><i data-feather="message-square"></i> نصيحة لك أيها المهندس:</h4>
                    <p class="mt-2 text-sm" style="color: #5f6368;">${getStaticGPAAdvice(data.cumulativeGPA)}</p>
                </div>
                <div class="text-center mt-6 pt-4 border-t border-dashed">
                     <p class="text-sm font-bold text-red-600">تنبيه: هذا الكشف تقديري وغير رسمي، ولا يغني عن الاستمارة المعتمدة من الكلية.</p>
                     <p class="text-xs mt-4 text-gray-500">تم إنشاؤه بواسطة أداة "مسارك الهندسي" | rebrand.ly/gpaeng-uob</p>
                </div>
            `;
            feather.replace();
            showModal('results_modal');
        }

        // --- SIMULATION & PLANNING ---
        function runSimulation() {
            const currentGPA = parseFloat(document.getElementById('sim_current_gpa').value);
            const currentUnits = parseInt(document.getElementById('sim_current_units').value);
            const targetGPA = parseFloat(document.getElementById('sim_target_gpa').value);
            const futureUnits = parseInt(document.getElementById('sim_future_units').value);
            const resultDiv = document.getElementById('simulation_result');
            if (isNaN(currentGPA) || isNaN(currentUnits) || isNaN(targetGPA) || isNaN(futureUnits)) { showToast("يرجى ملء جميع حقول المحاكاة.", "error"); return; }
            const reqAvgGrade = ((targetGPA * (currentUnits + futureUnits)) - (currentGPA * currentUnits)) / futureUnits;
            resultDiv.innerHTML = `<h3 class="text-xl font-bold mb-4">نتيجة المحاكاة</h3> ${getSimulationAdvice(reqAvgGrade, targetGPA, futureUnits)}`;
            resultDiv.classList.remove('hidden');
        }

        function addPlanCourse() {
            planCourseCount++;
            const courseRow = document.createElement('div');
            courseRow.id = 'plan_course_' + planCourseCount;
            courseRow.className = 'plan-course-row grid grid-cols-12 gap-3 p-3 rounded-lg border';
            courseRow.style.borderColor = 'var(--card-border)';
            courseRow.innerHTML = `
                <div class="col-span-8"><input type="text" placeholder="اسم المادة (مثال: رياضيات 1)" class="form-input p-2 plan-course-name"></div>
                <div class="col-span-3"><input type="number" placeholder="الوحدات" min="1" class="form-input p-2 plan-course-units"></div>
                <div class="col-span-1 flex items-center justify-end"><button onclick="removeCourse('plan_course_', ${planCourseCount})" class="p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/40" aria-label="حذف المادة من الخطة"><i data-feather="trash-2" class="text-red-500"></i></button></div>
            `;
            document.getElementById('plan_courses_container').appendChild(courseRow);
            feather.replace();
            courseRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // --- DASHBOARD & DATA MANAGEMENT ---
        function saveResult() {
            const result = { id: Date.now(), date: new Date().toISOString().split('T')[0], semesterGPA: lastCalculationData.semesterGPA, cumulativeGPA: lastCalculationData.cumulativeGPA, courses: lastCalculationData.courses };
            savedResults.push(result);
            localStorage.setItem('gpaResults', JSON.stringify(savedResults));
            showToast("تم حفظ النتيجة بنجاح!");
            closeModal('results_modal');
        }

        function loadDashboard() {
            const container = document.getElementById('saved-results-container');
            const noResultsMsg = document.getElementById('no-saved-results');
            noResultsMsg.classList.toggle('hidden', savedResults.length > 0);
            container.innerHTML = savedResults.length > 0 ? savedResults.slice().reverse().map(result => `
                <div class="p-4 rounded-lg border flex justify-between items-center transition-all hover:shadow-md hover:border-[var(--accent-color)]" style="border-color: var(--card-border); background-color: var(--input-bg);">
                    <div>
                        <span class="font-bold text-sm" style="color: var(--text-secondary);">${new Date(result.date).toLocaleDateString('ar-EG')}</span>
                        <div class="flex gap-4 mt-1">
                            <div><p class="text-xs">الفصلي</p><p class="font-bold text-lg" style="color: var(--accent-color);">${result.semesterGPA.toFixed(3)}</p></div>
                            <div><p class="text-xs">التراكمي</p><p class="font-bold text-lg" style="color: #1e8e3e;">${result.cumulativeGPA.toFixed(3)}</p></div>
                        </div>
                    </div>
                    <button onclick="deleteResult(${result.id})" class="p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/40" aria-label="حذف النتيجة"><i data-feather="trash-2" class="text-red-500"></i></button>
                </div>`).join('') : '';
            feather.replace();
            renderGPATrendChart();
        }
        
        function deleteResult(id) {
            const confirmBtn = document.getElementById('confirm_button');
            confirmBtn.onclick = () => {
                savedResults = savedResults.filter(r => r.id !== id);
                localStorage.setItem('gpaResults', JSON.stringify(savedResults));
                loadDashboard();
                closeModal('confirm_modal');
                showToast("تم حذف النتيجة بنجاح.");
            };
            showModal('confirm_modal');
        }
        
        function renderGPATrendChart() {
            const ctx = document.getElementById('gpa-chart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const fontColor = isDark ? '#e8eaed' : '#1f1f1f';
            if (gpaChart) gpaChart.destroy();
            if (savedResults.length === 0) return;
            gpaChart = new Chart(ctx, {
                type: 'line', data: { labels: savedResults.map(r => new Date(r.date).toLocaleDateString('ar-EG', { month: 'short' })), datasets: [{ label: 'المعدل التراكمي', data: savedResults.map(r => r.cumulativeGPA), borderColor: 'var(--accent-color)', backgroundColor: 'color-mix(in srgb, var(--accent-color) 20%, transparent)', fill: true, tension: 0.3, pointRadius: 5 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, ticks: { color: fontColor }, grid: { color: gridColor } }, x: { ticks: { color: fontColor }, grid: { color: gridColor } } }, plugins: { legend: { display: false } } }
            });
        }
        
        function exportResults() {
            if(savedResults.length === 0) { showToast("لا توجد بيانات لتصديرها.", "error"); return; }
            const dataStr = JSON.stringify(savedResults, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'gpa_results.json'; a.click(); URL.revokeObjectURL(a.href);
        }
        
        function importResults(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = e => { try { const imported = JSON.parse(e.target.result); if (Array.isArray(imported)) { savedResults = imported; localStorage.setItem('gpaResults', JSON.stringify(savedResults)); loadDashboard(); showToast("تم استيراد البيانات بنجاح!"); } else { throw new Error(); } } catch (error) { showToast("فشل استيراد الملف.", "error"); } };
            reader.readAsText(file);
        }

        // --- EXPORT & SHARE FUNCTIONS ---
        async function ensureImagesLoaded(container) {
            const images = Array.from(container.getElementsByTagName("img"));
            await Promise.all(images.map(img => {
                if (img.complete) return Promise.resolve();
                return new Promise(resolve => { img.onload = img.onerror = resolve; });
            }));
        }

        async function shareAsImage() {
            showToast("جاري تجهيز الصورة...", "info");
            const originalElement = document.getElementById('result-to-capture');
            
            const clone = originalElement.cloneNode(true);
            clone.id = 'result-clone-for-export';
            clone.style.position = 'absolute';
            clone.style.top = '0';
            clone.style.left = '-9999px';
            clone.style.width = '800px';
            clone.style.padding = '2rem';
            
            const tableWrapperInClone = clone.querySelector('.overflow-x-auto');
            if (tableWrapperInClone) {
                tableWrapperInClone.classList.remove('overflow-x-auto');
                tableWrapperInClone.style.overflow = 'visible';
            }

            document.body.appendChild(clone);
            await ensureImagesLoaded(clone);

            try {
                const canvas = await html2canvas(clone, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                const link = document.createElement('a');
                link.download = `gpa-result-${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (err) {
                console.error("Image generation failed:", err);
                showToast("حدث خطأ أثناء إنشاء الصورة.", "error");
            } finally {
                document.body.removeChild(clone);
            }
        }
        
        async function shareAsPDF() {
            showToast("جاري تجهيز ملف PDF...", "info");
            const originalElement = document.getElementById('result-to-capture');

            const clone = originalElement.cloneNode(true);
            clone.id = 'result-clone-for-export';
            clone.style.position = 'absolute';
            clone.style.top = '0';
            clone.style.left = '-9999px';
            clone.style.width = '800px'; 
            clone.style.padding = '2rem';
            
            const tableWrapperInClone = clone.querySelector('.overflow-x-auto');
            if (tableWrapperInClone) {
                tableWrapperInClone.classList.remove('overflow-x-auto');
                tableWrapperInClone.style.overflow = 'visible';
            }
            document.body.appendChild(clone);
            await ensureImagesLoaded(clone);

            try {
                const canvas = await html2canvas(clone, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                
                const pdf = new jsPDF('p', 'mm', 'a4'); 
                
                const imgProps= pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`gpa-result-${new Date().toISOString().slice(0,10)}.pdf`);
            } catch (err) {
                console.error("PDF generation failed:", err);
                showToast("حدث خطأ أثناء إنشاء الملف.", "error");
            } finally {
                document.body.removeChild(clone);
            }
        }
        
        function shareWebsite() {
            const shareData = {
                title: 'مسارك الهندسي: حاسبة المعدل الذكية',
                text: 'اكتشف معدلك التراكمي والفصلي المتوقع مع هذه الأداة المفيدة لطلاب هندسة بنغازي!',
                url: 'https://rebrand.ly/gpaeng-uob'
            };
            if (navigator.share) {
                navigator.share(shareData).catch(err => console.error("Error sharing:", err));
            } else {
                navigator.clipboard.writeText(shareData.url).then(() => { showToast('تم نسخ رابط الموقع!'); }).catch(err => { showToast('فشل نسخ الرابط.', 'error'); });
            }
        }
        
        // --- UTILITIES & HELPERS ---
        function setupInputValidation() {
             document.querySelectorAll('.form-input[type="number"], .form-select').forEach(input => {
                input.addEventListener('input', e => { e.target.classList.remove('input-invalid'); });
            });
        }
        
        function validateInputs(containerSelector) {
            let allValid = true;
            const container = document.querySelector(containerSelector);
            if (!container) return false;
            container.querySelectorAll('input, select').forEach(input => {
                input.classList.remove('input-invalid');
                if (!input.closest('.hidden') && input.value.trim() === '' && !(input.classList.contains('course-name') || input.classList.contains('plan-course-name'))) {
                    input.classList.add('input-invalid');
                    allValid = false;
                }
            });
            if (containerSelector === '#content-calculator') {
                 container.querySelectorAll('#courses_container .course-row').forEach(row => {
                    const type = row.querySelector('.btn-status.active').dataset.value;
                    const oldGradeInput = row.querySelector('.course-old-grade');
                    if (type === 'retaken') {
                        oldGradeInput.classList.remove('input-invalid');
                        if (oldGradeInput.value === '') {
                            oldGradeInput.classList.add('input-invalid');
                            allValid = false;
                        }
                    }
                });
            }
            return allValid;
        }

        function showModal(modalId) { 
            document.getElementById(modalId).classList.add('show');
            document.body.style.overflow = 'hidden';
        }
        function closeModal(modalId) { 
            document.getElementById(modalId).classList.remove('show');
            document.body.style.overflow = 'auto';
        }
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            if(!toast) return;
            const toastMessage = document.getElementById('toast-message');
            if(!toastMessage) return;
            toastMessage.textContent = message;
            toast.style.backgroundColor = type === 'error' ? 'var(--danger-color)' : '#2f855a';
            toast.style.color = 'white';
            toast.classList.remove('opacity-0', 'translate-y-3');
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-3'); }, 3000);
        }
        
        function getGradeOptions(isOldGrade = false) { 
            const options = `<option value="4.0">AA (4.0)</option><option value="3.5">A (3.5)</option><option value="3.0">BB (3.0)</option><option value="2.5">B (2.5)</option><option value="2.0">CC (2.0)</option><option value="1.5">C (1.5)</option><option value="1.0">DD (1.0)</option><option value="0.5">D (0.5)</option><option value="0.0">F (0.0)</option>`;
            return isOldGrade ? `<option value="" disabled selected>القديم</option>${options}` : `<option value="" disabled selected>اختر</option>${options}`;
        }
        function getGradeText(gradeValue) { const grades = {4.0: 'AA', 3.5: 'A', 3.0: 'BB', 2.5: 'B', 2.0: 'CC', 1.5: 'C', 1.0: 'DD', 0.5: 'D', 0.0: 'F'}; return grades[gradeValue] || `N/A`; }
        function getStaticGPAAdvice(cgpa) { if (cgpa >= 3.7) return "أداء استثنائي! أنت في الطليعة. حافظ على هذا المستوى المتميز واستمر في التفوق."; if (cgpa >= 3.0) return "عمل رائع! لقد حققت تقدماً ملحوظاً. استمر في البناء على هذا النجاح."; if (cgpa >= 2.0) return "أداء جيد! أنت تسير في الاتجاه الصحيح. حافظ على تركيزك لتحسين أدائك أكثر."; return "لا تستسلم! كل نتيجة هي فرصة للتعلم والنمو. حدد نقاط ضعفك وخطط جيداً للفصل القادم."; }
        function getSimulationAdvice(req, target, units) { if (req > 4.0) return `<p class="text-lg text-red-600 dark:text-red-400">للوصول إلى <strong>${target.toFixed(2)}</strong> خلال <strong>${units}</strong> وحدة، تحتاج لمتوسط <strong>${req.toFixed(2)}</strong>، وهو <span class="font-bold">غير ممكن</span>.</p>`; if (req < 0) return `<p class="text-lg text-green-600 dark:text-green-400">خبر رائع! معدلك الحالي أعلى من الهدف. حافظ على أدائك.</p>`; let advice = `لتحقيق هدفك، تحتاج لمتوسط <strong>${req.toFixed(2)}</strong> (ما يعادل تقدير <strong>${getGradeText(Math.ceil(req * 2) / 2)}</strong> أو أعلى) في الـ <strong>${units}</strong> وحدة القادمة.`; return `<p class="text-lg">${advice}</p>`; }
        
        // --- AI & CHAT FUNCTIONS ---
        async function generateStudyPlan() {
            if (!validateInputs('#content-simulation section:last-child')) {
                showToast("يرجى إدخال جميع المواد وعدد وحداتها.", "error");
                return;
            }
            const resultDiv = document.getElementById('study_plan_result');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = `<div class="p-4 flex items-center justify-center gap-3"><div class="loading-dots"><span></span><span></span><span></span></div><p>جاري إنشاء الخطة...</p></div>`;
            let coursesForPlan = [];
            document.querySelectorAll('#plan_courses_container .plan-course-row').forEach(row => {
                const name = row.querySelector('.plan-course-name').value;
                const units = row.querySelector('.plan-course-units').value;
                if(name && units) coursesForPlan.push(`- ${name} (${units} وحدات)`);
            });
            if (coursesForPlan.length === 0) { showToast("الرجاء إضافة مادة واحدة على الأقل.", "error"); resultDiv.classList.add('hidden'); return; }
            const prompt = `بصفتك مرشداً أكاديمياً خبيراً لطلاب الهندسة في جامعة بنغازي، قم بإنشاء خطة دراسية استراتيجية للفصل القادم. بيانات الطالب: المعدل الحالي ${document.getElementById('sim_current_gpa').value || 'غير محدد'}, الساعات المجتازة ${document.getElementById('sim_current_units').value || 'غير محدد'}. المواد المخطط لدراستها: ${coursesForPlan.join(', ')}. الخطة يجب أن تتضمن: تحليل للعبء الدراسي، توزيع مقترح لساعات المذاكرة، 3 نصائح استراتيجية، ورسالة تحفيزية. استخدم العناوين الغامقة والنقاط.`;
            try {
                const aiResponse = await callGeminiAPI(prompt, 'studyPlan');
                resultDiv.innerHTML = renderAIContent(aiResponse);
            } catch (error) {
                resultDiv.textContent = 'عذراً، حدث خطأ أثناء إنشاء الخطة. يرجى المحاولة مرة أخرى.';
            }
        }
        
        function renderAIContent(text) {
            let safeText = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            let html = safeText.split('\n').map(line => {
                line = line.trim().replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
                if (line.startsWith('* ') || line.startsWith('- ')) return `<li>${line.substring(2)}</li>`;
                if (line) return `<p>${line}</p>`;
                return '';
            }).join('');
            return html.replace(/<\/li><li>/g, '</li><li>').replace(/<p><\/p>/g, '').replace(/<li>/g, '<ul class="list-disc list-inside space-y-2 my-2"><li>').replace(/<\/li>(?!<li>)/g, '</li></ul>');
        }
        
        function setupChat() {
            appendMessage('أهلاً بك! أنا مرشدك الأكاديمي. اسألني عن أي شيء يخص الدراسة.', 'advisor');
        }
        
        async function handleSendMessage(e) {
            e.preventDefault();
            const chatInput = document.getElementById('chat-input');
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;
            appendMessage(userMessage, 'user');
            chatInput.value = '';
            showTypingIndicator();
            try {
                const aiResponse = await callGeminiAPI(userMessage, 'general');
                removeTypingIndicator();
                appendMessage(aiResponse, 'advisor');
            } catch (error) {
                removeTypingIndicator();
                appendMessage(error.message, 'advisor');
            }
        }

        function appendMessage(text, sender) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex items-end gap-2 max-w-[85%] ${sender === 'user' ? 'self-end flex-row-reverse' : 'self-start'}`;
            const content = sender === 'advisor' ? renderAIContent(text) : text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            messageDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0" style="background-color: var(--card-bg);"><i data-feather="${sender === 'user' ? 'user' : 'cpu'}"></i></div>
                <div class="chat-bubble ${sender === 'user' ? 'rounded-br-none' : 'rounded-bl-none'}" style="background-color: ${sender === 'user' ? 'var(--accent-color)' : 'var(--card-bg)'}; color: ${sender === 'user' ? (document.documentElement.classList.contains('dark') ? '#001d35' : 'white') : 'var(--text-primary)'};">${content}</div>
            `;
            chatMessages.appendChild(messageDiv);
            feather.replace();
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            if(document.getElementById('typing-indicator')) return;
            const chatMessages = document.getElementById('chat-messages');
            const indicatorDiv = document.createElement('div');
            indicatorDiv.id = 'typing-indicator';
            indicatorDiv.className = `flex items-end gap-2 max-w-[85%] self-start`;
            indicatorDiv.innerHTML = `<div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0" style="background-color: var(--card-bg);"><i data-feather="cpu"></i></div><div class="chat-bubble rounded-bl-none" style="background-color: var(--card-bg);"><div class="loading-dots"><span></span><span></span><span></span></div></div>`;
            chatMessages.appendChild(indicatorDiv);
            feather.replace();
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        async function callGeminiAPI(userMessage, requestType = 'general') {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            let systemInstruction = "أنت مرشد أكاديمي ذكي وخبير، متخصص في مساعدة طلاب كلية الهندسة بجامعة بنغازي. كن دائماً إيجابياً ومشجعاً، وقدم إجاباتك باللغة العربية بأسلوب واضح وموجز. أكِّد على أهمية مراجعة المصادر الرسمية في الكلية.";
            const payload = { contents: [{ parts: [{ text: userMessage }] }], systemInstruction: { parts: [{ text: systemInstruction }] }, generationConfig: { temperature: 0.6, maxOutputTokens: 1024 } };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) return text;
                console.error("Invalid API Response Structure:", result);
                if(result.promptFeedback && result.promptFeedback.blockReason) return "تم حظر الطلب لأسباب تتعلق بالسلامة. يرجى تعديل سؤالك.";
                return "عذراً، لم أتمكن من الحصول على استجابة.";
            } catch (error) {
                console.error("API Call failed:", error);
                throw new Error("حدث خطأ في الاتصال بالمرشد الذكي. يرجى التحقق من اتصالك بالإنترنت.");
            }
        }
    </script>
</body>
</html>

