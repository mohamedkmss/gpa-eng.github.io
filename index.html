<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مسارك الهندسي: حاسبة المعدل الذكية</title>
    
    <!-- Scripts & Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

    <!-- Google Fonts: Noto Sans Arabic for a modern, Google-like UI -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-main: #f8f9fa; --card-bg: #ffffff; --card-border: #e0e0e0; --text-primary: #1f1f1f; --text-secondary: #5f6368; --input-bg: #f1f3f4; --accent-color: #0b57d0; --accent-color-dark: #0a4cb6; --shadow-color: rgba(0, 0, 0, 0.08); --danger-color: #d93025; --danger-color-hover: #b0261d;
        }
        .dark {
            --bg-main: #1f1f1f; --card-bg: #2d2d2d; --card-border: #4a4a4a; --text-primary: #e8eaed; --text-secondary: #9aa0a6; --input-bg: #3c4043; --accent-color: #a8c7fa; --accent-color-dark: #c3d8fb; --shadow-color: rgba(0, 0, 0, 0.4); --danger-color: #f28b82; --danger-color-hover: #ee675d;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-15px); max-height: 0; } to { opacity: 1; transform: translateY(0); max-height: 500px; } }
        @keyframes fadeOut { to { opacity: 0; transform: scale(0.9); max-height: 0; padding-top: 0; padding-bottom: 0; margin-top: 0; margin-bottom: 0; border-width: 0; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .result-item {
            opacity: 0;
            animation: fadeInUp 0.5s ease-out forwards;
        }

        html { scroll-behavior: smooth; }
        body { font-family: 'Noto Sans Arabic', sans-serif; background-color: var(--bg-main); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        .card { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 1.5rem; box-shadow: 0 4px 16px var(--shadow-color); transition: all 0.3s; animation: fadeIn 0.5s ease-out forwards; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.6rem; padding: 0.75rem 1.5rem; border-radius: 1.5rem; font-weight: 600; transition: all 0.2s; cursor: pointer; border: none; }
        .btn:focus-visible { outline: 2px solid var(--accent-color); outline-offset: 2px; }
        .btn-primary { background-color: var(--accent-color); color: var(--bg-main); }
        .dark .btn-primary { color: #001d35; }
        .btn-primary:hover { background-color: var(--accent-color-dark); box-shadow: 0 2px 8px rgba(0,0,0,0.15); transform: translateY(-1px); }
        .btn-secondary { background-color: var(--input-bg); color: var(--text-primary); }
        .btn-secondary:hover { background-color: color-mix(in srgb, var(--card-border) 40%, transparent); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: var(--danger-color-hover); }
        .form-input, .form-select { background-color: var(--input-bg); border: 2px solid transparent; color: var(--text-primary); transition: all 0.2s; border-radius: 0.75rem; padding: 0.75rem; width: 100%; -webkit-appearance: none; appearance: none; }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: left 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-left: 2.5rem;
        }
        .dark .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239aa0a6' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }
        .form-input::placeholder { color: var(--text-secondary); opacity: 0.8; }
        .form-input:focus, .form-select:focus { border-color: var(--accent-color); background-color: var(--card-bg); outline: none; box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-color) 20%, transparent); }
        .form-input.input-invalid, .form-select.input-invalid { border-color: var(--danger-color); }
        .course-row, .plan-course-row { transition: all 0.4s ease-in-out, background-color 0.5s; animation: slideIn 0.5s forwards; overflow: hidden; }
        .highlight-row { background-color: color-mix(in srgb, var(--accent-color) 8%, transparent); }
        .modal-overlay { transition: opacity 0.3s; opacity: 0; pointer-events: none; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-content { animation: popIn 0.3s ease-out forwards; max-height: 90vh; display: flex; flex-direction: column; }
        #result-content-area { flex-grow: 1; display: flex; flex-direction: column; min-height: 0; overflow-y: auto; }
        .tab { position: relative; cursor: pointer; padding: 0.75rem 1rem; border-bottom: 3px solid transparent; color: var(--text-secondary); font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; transition: color 0.2s, background-color 0.2s; border-radius: 0.5rem 0.5rem 0 0; }
        .tab:hover { color: var(--text-primary); background-color: var(--input-bg); }
        .tab-active { color: var(--accent-color); }
        .dark .tab-active { color: var(--accent-color); }
        .tab-active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 3px; background-color: var(--accent-color); border-radius: 3px; }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        
        .transcript-table { width: 100%; border-collapse: collapse; font-size: 1rem; }
        .transcript-table th, .transcript-table td { border: 1px solid #ccc; padding: 0.75rem; text-align: center; }
        .transcript-table th { background-color: #f3f4f6; font-weight: bold; }
        .status-badge { padding: 0.2rem 0.6rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .status-new { background-color: #e8f0fe; color: #1967d2; }
        .status-retaken { background-color: #fef7e0; color: #b06000; }
        .help-section { background-color: var(--input-bg); padding: 1.25rem; border-radius: 1rem; }
        .help-section h3 { font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;}
        .help-section p, .help-section li { color: var(--text-secondary); }
        .help-section strong { color: var(--text-primary); }
        .chat-bubble { padding: 0.8rem 1.2rem; border-radius: 1.5rem; line-height: 1.6; max-width: 100%; word-wrap: break-word; }
        .chat-bubble ul { list-style-type: disc; padding-right: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .loading-dots span { height: 8px; width: 8px; background-color: var(--text-secondary); border-radius: 50%; display: inline-block; animation: wave 1.3s infinite; }
        .loading-dots span:nth-of-type(2) { animation-delay: -1.1s; }
        .loading-dots span:nth-of-type(3) { animation-delay: -0.9s; }
        @keyframes wave { 0%, 60%, 100% { transform: initial; } 30% { transform: translateY(-8px); } }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 3rem 1rem; opacity: 0.6; }
        .status-toggle-group { display: flex; background-color: var(--input-bg); border-radius: 0.75rem; padding: 0.25rem; border: 1px solid var(--card-border); }
        .btn-status { flex-grow: 1; padding: 0.5rem; border-radius: 0.6rem; border: none; background-color: transparent; color: var(--text-secondary); font-weight: 600; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-status.active { background-color: var(--card-bg); color: var(--text-primary); font-weight: 700; box-shadow: 0 1px 2px rgba(0,0,0,0.05), 0 2px 8px rgba(0,0,0,0.05); }
        @media (max-width: 768px) {
            .card { border-radius: 1rem; padding: 1.25rem; }
            .modal-content { width: calc(100% - 2rem); }
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        
        <header class="text-center mb-8 relative">
             <div class="flex justify-center items-center mb-4">
                <img src="./uob-logo.png" alt="شعار جامعة بنغازي" class="w-24 h-24 object-contain">
             </div>
            <h1 class="text-3xl md:text-4xl font-bold">مسارك الهندسي</h1>
            <p class="text-lg mt-2" style="color: var(--text-secondary);">حاسبة المعدل والمرشد الذكي لطلاب الهندسة - جامعة بنغازي</p>
            <div class="absolute top-0 left-0">
                <button id="theme-toggle" class="btn btn-secondary p-3 rounded-full !gap-0" aria-label="تبديل الوضع الليلي">
                    <i data-feather="sun" id="theme-icon-light"></i>
                    <i data-feather="moon" id="theme-icon-dark"></i>
                </button>
            </div>
        </header>

        <main class="card p-6 md:p-10">
            <!-- Tabs -->
            <nav class="flex flex-wrap border-b mb-8" style="border-color: var(--card-border);">
                <a id="tab-calculator" class="tab tab-active" onclick="switchTab('calculator')"><i data-feather="plus-circle"></i> حساب الفصل</a>
                <a id="tab-simulation" class="tab" onclick="switchTab('simulation')"><i data-feather="trending-up"></i> التخطيط للمستقبل</a>
                <a id="tab-advisor" class="tab" onclick="switchTab('advisor')"><i data-feather="message-circle"></i> المرشد الذكي</a>
                <a id="tab-dashboard" class="tab" onclick="switchTab('dashboard')"><i data-feather="bar-chart-2"></i> لوحة التحكم</a>
                <a id="tab-help" class="tab" onclick="switchTab('help')"><i data-feather="help-circle"></i> مساعدة</a>
            </nav>

            <!-- Calculator Content -->
            <div id="content-calculator" class="tab-content active">
                <section class="space-y-10">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 border-r-4 pr-4" style="border-color: var(--accent-color);">الخطوة 1: بياناتك الحالية</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="prev_gpa" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">معدلك التراكمي الحالي (المعدل العام)</label>
                                <input type="number" id="prev_gpa" step="0.001" placeholder="مثال: 3.250" class="form-input text-lg">
                            </div>
                            <div>
                                <label for="prev_units" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">عدد الساعات الإجمالية</label>
                                <input type="number" id="prev_units" min="0" placeholder="مثال: 120" class="form-input text-lg">
                            </div>
                        </div>
                        <p class="text-xs mt-3 p-2 rounded-md" style="color: var(--text-secondary); background-color: var(--input-bg);">
                            <strong>ملاحظة:</strong> أدخل 0 إذا كنت طالب فصل أول. يمكنك إيجاد هذه البيانات في آخر استمارة درجات.
                        </p>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-2 border-r-4 pr-4" style="border-color: var(--accent-color);">الخطوة 2: مواد هذا الفصل</h2>
                        <p class="text-sm mb-4" style="color: var(--text-secondary);">
                            أضف موادك وحدد حالتها. إذا كانت "معادة"، سيظهر حقل لإدخال تقديرك القديم.
                        </p>
                        <div id="courses_container" class="space-y-4"></div>
                        <div class="mt-4">
                            <button onclick="addCourse()" class="btn btn-secondary">
                                <i data-feather="plus"></i> إضافة مادة
                            </button>
                        </div>
                    </div>
                    <div class="text-center border-t pt-8 mt-8" style="border-color: var(--card-border);">
                        <button onclick="calculateGPA()" class="btn btn-primary text-xl px-16 py-4">
                            <i data-feather="bar-chart"></i> احسب المعدل
                        </button>
                    </div>
                </section>
            </div>
            
            <!-- Simulation Content -->
            <div id="content-simulation" class="tab-content">
                 <div class="space-y-8">
                    <!-- Target GPA Simulation -->
                    <section>
                        <h2 class="text-2xl font-bold mb-4 border-r-4 pr-4" style="border-color: var(--accent-color);">محاكاة الوصول لهدفك</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                           <div>
                                <label for="sim_current_gpa" class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">معدلك التراكمي الحالي</label>
                                <input type="number" id="sim_current_gpa" step="0.001" placeholder="أدخل معدلك الحالي" class="form-input">
                            </div>
                            <div>
                                <label for="sim_current_units" class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">عدد الساعات الإجمالية</label>
                                <input type="number" id="sim_current_units" min="0" placeholder="أدخل وحداتك الإجمالية" class="form-input">
                            </div>
                            <div>
                                <label for="sim_target_gpa" class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">المعدل الذي تطمح إليه</label>
                                <input type="number" id="sim_target_gpa" step="0.001" placeholder="مثال: 3.500" class="form-input">
                            </div>
                            <div>
                                <label for="sim_future_units" class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">كم عدد الوحدات القادمة؟</label>
                                <input type="number" id="sim_future_units" min="1" placeholder="مثال: 18" class="form-input">
                            </div>
                        </div>
                        <div class="text-center">
                            <button onclick="runSimulation()" class="btn btn-secondary"><i data-feather="activity"></i> حلّل هدفي</button>
                        </div>
                        <div id="simulation_result" class="text-center p-6 rounded-lg hidden mt-6" style="background-color: var(--input-bg);"></div>
                    </section>
                    
                    <!-- AI Study Plan Generator -->
                    <section class="border-t pt-8" style="border-color: var(--card-border);">
                        <h2 class="text-2xl font-bold mb-4 border-r-4 pr-4" style="border-color: var(--accent-color);">إنشاء خطة دراسية بالذكاء الاصطناعي</h2>
                        <p class="mb-4" style="color: var(--text-secondary);">أدخل موادك للفصل القادم وسيقوم المرشد الذكي بإنشاء خطة دراسية مخصصة لمساعدتك على تحقيق أفضل النتائج.</p>
                        <div id="plan_courses_container" class="space-y-4"></div>
                        <div class="mt-4 flex gap-4">
                            <button onclick="addPlanCourse()" class="btn btn-secondary">
                                <i data-feather="plus"></i> إضافة مادة للخطة
                            </button>
                        </div>
                         <div class="text-center border-t pt-8 mt-8" style="border-color: var(--card-border);">
                            <button onclick="generateStudyPlan()" class="btn btn-primary"><i data-feather="cpu"></i> أنشئ الخطة الآن</button>
                        </div>
                        <div id="study_plan_result" class="p-6 rounded-lg hidden mt-6" style="background-color: var(--input-bg);"></div>
                    </section>
                 </div>
            </div>

            <!-- AI Advisor Content -->
            <div id="content-advisor" class="tab-content">
                <section>
                    <h2 class="text-2xl font-bold mb-4">المرشد الأكاديمي الذكي</h2>
                    <div id="chat-container" class="h-[500px] flex flex-col rounded-lg overflow-hidden border" style="background-color: var(--input-bg); border-color: var(--card-border);">
                        <div id="chat-messages" class="flex-grow p-4 overflow-y-auto flex flex-col gap-4">
                            <!-- Messages are appended here -->
                        </div>
                        <div class="p-4 border-t" style="border-color: var(--card-border); background-color: var(--card-bg);">
                            <form id="chat-form" class="flex items-center gap-2">
                                <input type="text" id="chat-input" placeholder="اكتب سؤالك هنا..." class="form-input flex-grow !rounded-full" autocomplete="off">
                                <button type="submit" id="send-button" class="btn btn-primary !rounded-full !p-3 !gap-0" aria-label="إرسال الرسالة">
                                    <i data-feather="send"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Dashboard Content -->
            <div id="content-dashboard" class="tab-content">
                <section>
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">لوحة التحكم</h2>
                        <div class="flex gap-2">
                            <button onclick="exportResults()" class="btn btn-secondary"><i data-feather="download"></i> تصدير</button>
                            <button onclick="document.getElementById('import-input').click()" class="btn btn-secondary"><i data-feather="upload"></i> استيراد</button>
                            <input type="file" id="import-input" class="hidden" accept=".json" onchange="importResults(event)">
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="p-4 rounded-xl" style="background-color: var(--input-bg);">
                            <h3 class="font-bold mb-4">تطور المعدل التراكمي</h3>
                            <div class="h-64"><canvas id="gpa-chart"></canvas></div>
                        </div>
                        <h3 class="font-bold text-xl pt-4 border-t" style="border-color: var(--card-border);">النتائج المحفوظة</h3>
                        <div id="saved-results-container" class="space-y-4"></div>
                        <div id="no-saved-results" class="hidden">
                             <div class="empty-state">
                                <i data-feather="archive" class="w-16 h-16 mb-4"></i>
                                <h4 class="font-bold text-lg">لا توجد نتائج محفوظة</h4>
                                <p style="color: var(--text-secondary);">سيتم عرض النتائج التي تحفظها هنا.</p>
                             </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Help Content -->
            <div id="content-help" class="tab-content">
                <section class="space-y-6">
                     <div class="help-section">
                        <h3><i data-feather="file-text"></i> كيفية قراءة استمارتك</h3>
                        <p class="mb-3">لاستخدام الحاسبة بدقة، تحتاج لإدخال <strong>"المعدل العام"</strong> و <strong>"الساعات الإجمالية"</strong> من استمارتك الجامعية.</p>
                        <div class="flex justify-center p-2 border rounded-lg" style="background-color: var(--card-bg); border-color: var(--card-border);">
                           <img src="./transcript-guide.png" alt="شرح استمارة جامعة بنغازي" class="rounded-md shadow-md max-w-full h-auto">
                        </div>
                    </div>
                     <div class="help-section">
                        <h3><i data-feather="award"></i> نظام التقديرات المعتمد</h3>
                         <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-center text-sm font-mono">
                            <div class="p-2 rounded" style="background-color: var(--card-bg); color: var(--text-primary);">AA = 4.0</div>
                            <div class="p-2 rounded" style="background-color: var(--card-bg); color: var(--text-primary);">A = 3.5</div>
                            <div class="p-2 rounded" style="background-color: var(--card-bg); color: var(--text-primary);">BB = 3.0</div>
                            <div class="p-2 rounded" style="background-color: var(--card-bg); color: var(--text-primary);">B = 2.5</div>
                            <div class="p-2 rounded" style="background-color: var(--card-bg); color: var(--text-primary);">CC = 2.0</div>
                            <div class="p-2 rounded" style="background-color: var(--card-bg); color: var(--text-primary);">C = 1.5</div>
                            <div class="p-2 rounded" style="background-color: var(--card-bg); color: var(--text-primary);">DD = 1.0</div>
                            <div class="p-2 rounded" style="background-color: var(--card-bg); color: var(--text-primary);">D = 0.5</div>
                            <div class="p-2 rounded" style="background-color: var(--card-bg); color: var(--text-primary);">F = 0.0</div>
                        </div>
                    </div>
                    <div class="help-section">
                        <h3><i data-feather="help-circle"></i> أسئلة شائعة</h3>
                        <ul class="list-disc list-inside space-y-3">
                            <li><strong>ماذا أفعل في حالة الرسوب (F)؟</strong><br>عند إعادة المادة وتحصيل تقدير جديد، سيتم إلغاء تأثير التقدير القديم (F) واحتساب التقدير الجديد فقط في المعدل التراكمي. الساعات لا تضاف مرة أخرى.</li>
                            <li><strong>ماذا لو رسبت في مادة اختيارية؟</strong><br>إذا رسبت في مادة اختيارية، يمكنك إعادتها أو دراسة مادة اختيارية أخرى بدلاً عنها. في كلتا الحالتين، تأثير الرسوب القديم سيبقى في المعدل حتى تجتاز مادة اختيارية بنفس عدد الوحدات.</li>
                            <li><strong>كيف يتم التعامل مع المواد المحذوفة (W)؟</strong><br>المواد التي يتم حذفها (Withdrawal) لا تدخل في حساب المعدل التراكمي ولا تؤثر عليه.</li>
                            <li><strong>هل تؤثر علامة "غير مكتمل" (I) على المعدل؟</strong><br>لا، علامة "غير مكتمل" (Incomplete) لا تدخل في حساب المعدل. يجب إكمال متطلبات المادة لتحويلها إلى تقدير نهائي.</li>
                        </ul>
                    </div>
                     <div class="help-section">
                        <h3><i data-feather="info"></i> إرشادات هامة</h3>
                         <ul class="list-disc list-inside space-y-3">
                            <li><strong>للمواد المعادة:</strong> أدخل التقدير القديم بدقة. الحاسبة ستقوم تلقائياً بخصم نقاط التقدير القديم وإضافة نقاط التقدير الجديد، مع الحفاظ على عدد الساعات ثابتاً.</li>
                            <li><strong>دقة البيانات:</strong> تأكد من إدخال معدلك وساعاتك الإجمالية من آخر استمارة صادرة من الكلية لضمان الحصول على نتيجة دقيقة.</li>
                            <li><strong>أداة تقديرية:</strong> تذكر أن هذه الأداة للمساعدة والإرشاد فقط، والنتائج الرسمية هي التي تصدرها الكلية.</li>
                        </ul>
                    </div>
                </section>
            </div>
        </main>
        
        <footer class="text-center mt-8 text-sm" style="color: var(--text-secondary);">
            <p>&copy; <span id="year"></span> - تم التطوير لخدمة طلاب جامعة بنغازي.</p>
        </footer>
    </div>

    <!-- Results Modal -->
    <div id="results_modal" class="fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50">
        <div class="card modal-content p-0 w-full max-w-3xl relative">
             <button onclick="closeModal('results_modal')" class="absolute top-4 left-4 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 z-20" aria-label="إغلاق النافذة">
                <i data-feather="x" class="w-6 h-6" style="color: var(--text-secondary)"></i>
            </button>
            <div id="result-content-area" class="p-4 sm:p-6">
                 <!-- Transcript Content will be dynamically generated here -->
            </div>
            <div id="modal-buttons" class="flex flex-wrap justify-center gap-3 p-4 border-t" style="border-color: var(--card-border);">
                <button onclick="saveResult()" class="btn btn-primary"><i data-feather="save"></i> حفظ النتيجة</button>
                <button onclick="shareWebsite()" class="btn btn-secondary"><i data-feather="share-2"></i> مشاركة الموقع</button>
                <button onclick="shareAsImage()" class="btn btn-secondary"><i data-feather="camera"></i> حفظ كصورة</button>
                <button onclick="shareAsPDF()" class="btn btn-secondary"><i data-feather="file-text"></i> حفظ كـ PDF</button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm_modal" class="fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50">
        <div class="card modal-content p-8 w-full max-w-sm text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full" style="background-color: color-mix(in srgb, var(--danger-color) 15%, transparent);"><i data-feather="trash-2" class="w-6 h-6" style="color: var(--danger-color);"></i></div>
            <h3 class="text-lg font-medium leading-6 mt-4" id="confirm_title">حذف النتيجة</h3>
            <div class="mt-2">
                <p class="text-sm" style="color: var(--text-secondary);" id="confirm_message">هل أنت متأكد من رغبتك في حذف هذه النتيجة؟ لا يمكن التراجع عن هذا الإجراء.</p>
            </div>
            <div class="mt-6 flex justify-center gap-4">
                <button id="confirm_button" class="btn btn-danger">تأكيد الحذف</button>
                <button onclick="closeModal('confirm_modal')" class="btn btn-secondary">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 py-3 px-6 rounded-full shadow-xl opacity-0 translate-y-3 transition-all duration-300 z-[100]">
        <p id="toast-message"></p>
    </div>

    <script>
        // --- GLOBAL VARIABLES & INITIALIZATION ---
        let courseCount = 0, planCourseCount = 0, savedResults = [], gpaChart = null, lastCalculationData = {};
        
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            setupTheme();
            loadSavedResults();
            addCourse();
            addPlanCourse();
            setupInputValidation();
            document.getElementById('year').textContent = new Date().getFullYear();
            document.getElementById('chat-form').addEventListener('submit', handleSendMessage);
            setupChat();
        });

        // --- THEME & UI ---
        function applyTheme(theme) {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            document.getElementById('theme-icon-light').style.display = theme === 'dark' ? 'none' : 'block';
            document.getElementById('theme-icon-dark').style.display = theme === 'dark' ? 'block' : 'none';
            if (gpaChart) {
                setTimeout(() => renderGPATrendChart(), 10);
            }
        }

        function setupTheme() {
            const setInitialTheme = () => {
                const savedTheme = localStorage.getItem('theme');
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(savedTheme || (systemPrefersDark ? 'dark' : 'light'));
            };
            setInitialTheme();
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (!localStorage.getItem('theme')) {
                    applyTheme(e.matches ? 'dark' : 'light');
                }
            });
            document.getElementById('theme-toggle').addEventListener('click', () => {
                const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
            document.getElementById(`content-${tabName}`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
            if (tabName === 'dashboard') loadDashboard();
        }

        // --- GPA CALCULATOR ---
        function addCourse() {
            courseCount++;
            const courseRow = document.createElement('div');
            courseRow.id = 'course_' + courseCount;
            courseRow.className = 'course-row p-3 rounded-lg border';
            courseRow.style.borderColor = 'var(--card-border)';
            courseRow.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-12 gap-x-3 gap-y-3 items-center">
                    <div class="md:col-span-4"><input type="text" placeholder="اسم المادة" class="form-input p-2 course-name"></div>
                    <div class="md:col-span-4 flex gap-3">
                        <div class="w-1/2"><input type="number" placeholder="الوحدات" min="1" class="form-input p-2 course-units"></div>
                        <div class="w-1/2"><select class="form-select p-2 course-grade">${getGradeOptions()}</select></div>
                    </div>
                    <div class="md:col-span-3">
                        <div class="status-toggle-group">
                            <button type="button" class="btn-status active" data-value="new" onclick="setCourseType(this, ${courseCount})">جديدة</button>
                            <button type="button" class="btn-status" data-value="retaken" onclick="setCourseType(this, ${courseCount})">معادة</button>
                        </div>
                    </div>
                    <div class="md:col-span-1 flex justify-end"><button onclick="removeCourse('course_', ${courseCount})" class="p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/40" aria-label="حذف المادة"><i data-feather="trash-2" class="text-red-500"></i></button></div>
                    <div id="old-grade-container-${courseCount}" class="md:col-span-12 hidden mt-2">
                        <div class="p-3 rounded-md" style="background-color: var(--input-bg);"><label for="old-grade-select-${courseCount}" class="block text-sm text-center font-medium mb-2" style="color:var(--text-secondary)">أدخل التقدير القديم للمادة المعادة</label><div class="max-w-xs mx-auto"><select id="old-grade-select-${courseCount}" class="form-select p-2 course-old-grade">${getGradeOptions(true)}</select></div></div>
                    </div>
                </div>
            `;
            document.getElementById('courses_container').appendChild(courseRow);
            feather.replace();
            courseRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function setCourseType(btn, courseId) {
            const parent = btn.parentElement;
            parent.querySelector('.btn-status.active').classList.remove('active');
            btn.classList.add('active');
            toggleOldGrade(btn.dataset.value, courseId);
        }

        function removeCourse(prefix, id) {
            const courseRow = document.getElementById(prefix + id);
            if (courseRow) {
                 courseRow.style.animation = 'fadeOut 0.4s forwards';
                 setTimeout(() => courseRow.remove(), 400);
            }
        }

        function toggleOldGrade(courseType, courseId) {
            const container = document.getElementById(`old-grade-container-${courseId}`);
            if(!container) return;
            container.classList.toggle('hidden', courseType !== 'retaken');
        }

        function calculateGPA() {
            if (!validateInputs('#content-calculator')) return;
            const prevGPA = parseFloat(document.getElementById('prev_gpa').value) || 0;
            const prevUnits = parseInt(document.getElementById('prev_units').value) || 0;
            let cumulativePoints = prevGPA * prevUnits; let cumulativeUnits = prevUnits; let semesterPoints = 0; let semesterUnits = 0; let courses = [];
            document.querySelectorAll('#courses_container .course-row').forEach(row => {
                const units = parseInt(row.querySelector('.course-units').value);
                const grade = parseFloat(row.querySelector('.course-grade').value);
                if (!units || isNaN(grade)) return;
                const type = row.querySelector('.btn-status.active').dataset.value;
                semesterPoints += grade * units; semesterUnits += units;
                if (type === 'new') {
                    cumulativePoints += grade * units; cumulativeUnits += units;
                } else {
                    const oldGrade = parseFloat(row.querySelector('.course-old-grade').value);
                    cumulativePoints += (grade * units) - (oldGrade * units);
                }
                courses.push({ name: row.querySelector('.course-name').value || 'مادة', units, grade, type });
            });
            const semesterGPA = semesterUnits > 0 ? (semesterPoints / semesterUnits) : 0;
            const cumulativeGPA = cumulativeUnits > 0 ? (cumulativePoints / cumulativeUnits) : 0;
            lastCalculationData = { semesterGPA, cumulativeGPA, semesterUnits, cumulativeUnits, courses };
            displayResults(lastCalculationData);
        }

        function getTranscriptHTMLForExport(data) {
            const today = new Date().toLocaleDateString('ar-EG-u-nu-latn', { year: 'numeric', month: 'long', day: 'numeric' });
            const styles = `
                <style>
                    body { font-family: 'Noto Sans Arabic', sans-serif; }
                    .export-wrapper { background-color: #ffffff; color: #1f1f1f; padding: 2rem; width: 800px; box-sizing: border-box; }
                    .export-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 1rem; margin-bottom: 1.5rem; }
                    .export-header img { width: 112px; height: 112px; }
                    .export-header-text { text-align: center; }
                    .export-header-text h2 { font-size: 1.5rem; font-weight: 700; margin: 0; }
                    .export-header-text p { font-size: 1.125rem; margin: 0.25rem 0; }
                    .export-header-text span { font-size: 0.875rem; color: #5f6368; }
                    .export-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
                    .summary-box { padding: 1rem; border-radius: 0.5rem; text-align: center; }
                    .summary-box .label { font-size: 0.875rem; font-weight: 600; }
                    .summary-box .value { font-size: 2.25rem; font-weight: 700; }
                    .summary-box .units { font-size: 0.75rem; color: #5f6368; }
                    .semester-box { background-color: #e8f0fe; color: #1967d2; }
                    .semester-box .value { color: #0b57d0; }
                    .cumulative-box { background-color: #e6f4ea; color: #1e8e3e; }
                    .cumulative-box .value { color: #188038; }
                    .transcript-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 1rem; }
                    .transcript-table th, .transcript-table td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
                    .transcript-table th { background-color: #f3f4f6; font-weight: bold; }
                    .advice-box { margin-top: 1.5rem; padding: 1rem; border-radius: 0.5rem; background-color: #f1f3f4; }
                    .advice-box h4 { font-weight: bold; margin: 0; display: flex; align-items: center; gap: 0.5rem; }
                    .advice-box p { margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #5f6368; }
                    .export-footer { text-align: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px dashed #ccc; }
                    .export-footer .warning { font-size: 0.875rem; font-weight: bold; color: #d93025; }
                    .export-footer .credit { font-size: 0.75rem; margin-top: 1rem; color: #5f6368; }
                </style>`;

            return `
                ${styles}
                <div class="export-wrapper">
                    <div class="export-header">
                        <img src="./uob-logo.png" alt="شعار الجامعة">
                        <div class="export-header-text">
                            <h2>جامعة بنغازي - كلية الهندسة</h2>
                            <p>كشف درجات تقديري</p>
                            <span>تاريخ الإصدار: ${today}</span>
                        </div>
                        <div style="width: 112px;"></div>
                    </div>
                    <div class="export-summary">
                        <div class="summary-box semester-box">
                            <p class="label">المعدل الفصلي</p>
                            <p class="value">${data.semesterGPA.toFixed(3)}</p>
                            <p class="units">${data.semesterUnits} وحدات</p>
                        </div>
                        <div class="summary-box cumulative-box">
                            <p class="label">المعدل التراكمي</p>
                            <p class="value">${data.cumulativeGPA.toFixed(3)}</p>
                            <p class="units">${data.cumulativeUnits} ساعة إجمالية</p>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="transcript-table">
                            <thead><tr><th>اسم المادة</th><th>الحالة</th><th>الوحدات</th><th>التقدير</th><th>النقاط</th></tr></thead>
                            <tbody>${data.courses.map(c => `<tr><td>${c.name}</td><td><span class="status-badge ${c.type === 'retaken' ? 'status-retaken' : 'status-new'}">${c.type === 'retaken' ? 'معادة' : 'جديدة'}</span></td><td>${c.units}</td><td><span style="direction: ltr; display: inline-block; width: 100%;">${getGradeText(c.grade)} (${c.grade.toFixed(1)})</span></td><td>${(c.units * c.grade).toFixed(2)}</td></tr>`).join('')}</tbody>
                        </table>
                    </div>
                    <div class="advice-box">
                        <h4><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> نصيحة لك أيها المهندس:</h4>
                        <p>${getStaticGPAAdvice(data.cumulativeGPA)}</p>
                    </div>
                    <div class="export-footer">
                        <p class="warning">تنبيه: هذا الكشف تقديري وغير رسمي، ولا يغني عن الاستمارة المعتمدة من الكلية.</p>
                        <p class="credit">تم إنشاؤه بواسطة أداة "مسارك الهندسي" | rebrand.ly/gpaeng-uob</p>
                    </div>
                </div>`;
        }


        function displayResults(data) {
            const resultContainer = document.getElementById('result-content-area');
            const summaryHTML = `
                 <div class="transcript-header flex justify-between items-center result-item">
                    <img src="./uob-logo.png" alt="شعار الجامعة" class="w-28 h-28 object-contain">
                    <div class="text-center">
                        <h2 class="text-xl sm:text-2xl font-bold">نتيجتك التقديرية</h2>
                    </div>
                    <div class="w-28"></div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div class="p-4 rounded-lg text-center result-item" style="background-color: color-mix(in srgb, var(--accent-color) 15%, transparent); animation-delay: 0.1s;">
                        <p class="text-sm font-semibold" style="color: var(--accent-color);">المعدل الفصلي</p>
                        <p class="text-3xl font-bold" style="color: var(--accent-color);">${data.semesterGPA.toFixed(3)}</p>
                        <p class="text-xs" style="color: var(--text-secondary);">${data.semesterUnits} وحدات</p>
                    </div>
                    <div class="p-4 rounded-lg text-center result-item" style="background-color: #e6f4ea; animation-delay: 0.2s;" >
                        <p class="text-sm font-semibold" style="color: #1e8e3e;">المعدل التراكمي</p>
                        <p class="text-3xl font-bold" style="color: #188038;">${data.cumulativeGPA.toFixed(3)}</p>
                        <p class="text-xs" style="color: #5f6368;">${data.cumulativeUnits} ساعة إجمالية</p>
                    </div>
                </div>`;

            resultContainer.innerHTML = summaryHTML + `
                <div class="text-center my-4 result-item" style="animation-delay: 0.3s;">
                    <button id="toggle-courses-btn" class="btn btn-secondary text-sm !py-2 !px-4"><i data-feather="list"></i> عرض تفاصيل المواد</button>
                </div>
                <div id="courses-table-container" class="hidden result-item" style="animation-delay: 0.4s;">
                     <div class="overflow-x-auto mt-4"><table class="transcript-table"><thead><tr><th>اسم المادة</th><th>الحالة</th><th>الوحدات</th><th>التقدير</th><th>النقاط</th></tr></thead><tbody>${data.courses.map(c => `<tr><td>${c.name}</td><td><span class="status-badge ${c.type === 'retaken' ? 'status-retaken' : 'status-new'}">${c.type === 'retaken' ? 'معادة' : 'جديدة'}</span></td><td>${c.units}</td><td><span style="direction: ltr; display: inline-block; width: 100%;">${getGradeText(c.grade)} (${c.grade.toFixed(1)})</span></td><td>${(c.units * c.grade).toFixed(2)}</td></tr>`).join('')}</tbody></table></div>
                </div>`;
            
            document.getElementById('toggle-courses-btn').addEventListener('click', toggleCoursesDisplay);
            feather.replace();
            showModal('results_modal');
        }
        
        function toggleCoursesDisplay() {
            const container = document.getElementById('courses-table-container');
            const btn = document.getElementById('toggle-courses-btn');
            const isHidden = container.classList.toggle('hidden');
            btn.innerHTML = isHidden ? '<i data-feather="list"></i> عرض تفاصيل المواد' : '<i data-feather="chevrons-up"></i> إخفاء تفاصيل المواد';
            feather.replace();
        }

        // --- SIMULATION & PLANNING ---
        function runSimulation() {
            if (!validateInputs('#content-simulation')) return;
            const currentGPA = parseFloat(document.getElementById('sim_current_gpa').value);
            const currentUnits = parseInt(document.getElementById('sim_current_units').value);
            const targetGPA = parseFloat(document.getElementById('sim_target_gpa').value);
            const futureUnits = parseInt(document.getElementById('sim_future_units').value);
            const reqAvgGrade = ((targetGPA * (currentUnits + futureUnits)) - (currentGPA * currentUnits)) / futureUnits;
            document.getElementById('simulation_result').innerHTML = `<h3 class="text-xl font-bold mb-4">نتيجة المحاكاة</h3> ${getSimulationAdvice(reqAvgGrade, targetGPA, futureUnits)}`;
            document.getElementById('simulation_result').classList.remove('hidden');
        }

        // --- DATA MANAGEMENT ---
        function saveResult() {
            const result = { id: Date.now(), ...lastCalculationData };
            savedResults.push(result);
            localStorage.setItem('gpaResults', JSON.stringify(savedResults));
            showToast("تم حفظ النتيجة بنجاح!");
            closeModal('results_modal');
        }

        function loadSavedResults() {
             try { savedResults = JSON.parse(localStorage.getItem('gpaResults')) || []; if (!Array.isArray(savedResults)) savedResults = []; } catch (e) { savedResults = []; }
        }

        function loadDashboard() {
            const container = document.getElementById('saved-results-container');
            document.getElementById('no-saved-results').classList.toggle('hidden', savedResults.length > 0);
            container.innerHTML = savedResults.length > 0 ? savedResults.slice().reverse().map(result => `
                <div class="p-4 rounded-lg border flex justify-between items-center transition-all hover:shadow-md hover:border-[var(--accent-color)]" style="border-color: var(--card-border); background-color: var(--input-bg);">
                    <div><span class="font-bold text-sm" style="color: var(--text-secondary);">${new Date(result.date).toLocaleDateString('ar-EG')}</span><div class="flex gap-4 mt-1"><div><p class="text-xs">الفصلي</p><p class="font-bold text-lg" style="color: var(--accent-color);">${result.semesterGPA.toFixed(3)}</p></div><div><p class="text-xs">التراكمي</p><p class="font-bold text-lg" style="color: #1e8e3e;">${result.cumulativeGPA.toFixed(3)}</p></div></div></div>
                    <button onclick="deleteResult(${result.id})" class="p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/40" aria-label="حذف النتيجة"><i data-feather="trash-2" class="text-red-500"></i></button>
                </div>`).join('') : '';
            feather.replace();
            renderGPATrendChart();
        }
        
        function deleteResult(id) {
            showModal('confirm_modal');
            document.getElementById('confirm_button').onclick = () => {
                savedResults = savedResults.filter(r => r.id !== id);
                localStorage.setItem('gpaResults', JSON.stringify(savedResults));
                loadDashboard(); closeModal('confirm_modal'); showToast("تم حذف النتيجة.");
            };
        }
        
        // --- EXPORT & SHARE FUNCTIONS ---
        async function createExportCanvas() {
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.innerHTML = getTranscriptHTMLForExport(lastCalculationData);
            document.body.appendChild(tempDiv);
            feather.replace(); 
            await ensureImagesLoaded(tempDiv);
            const elementToRender = tempDiv.querySelector('.export-wrapper');
            const canvas = await html2canvas(elementToRender, { scale: 3, useCORS: true, backgroundColor: '#ffffff' });
            document.body.removeChild(tempDiv);
            return canvas;
        }

        async function shareAsImage() {
            showToast("جاري تجهيز الصورة...", "info");
            try {
                const canvas = await createExportCanvas();
                const link = document.createElement('a');
                link.download = `gpa-result-${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (err) {
                console.error("Image generation failed:", err);
                showToast("حدث خطأ أثناء إنشاء الصورة.", "error");
            }
        }
        
        async function shareAsPDF() {
            showToast("جاري تجهيز ملف PDF...", "info");
            try {
                const canvas = await createExportCanvas();
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4'); 
                const imgProps= pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`gpa-result-${new Date().toISOString().slice(0,10)}.pdf`);
            } catch (err) {
                console.error("PDF generation failed:", err);
                showToast("حدث خطأ أثناء إنشاء الملف.", "error");
            }
        }
        
        // --- UTILITIES & HELPERS ---
        function setupInputValidation() {
            ['prev_gpa', 'sim_current_gpa', 'sim_target_gpa'].forEach(id => {
                const inputElement = document.getElementById(id);
                if (inputElement) {
                    inputElement.addEventListener('blur', () => {
                        const value = parseFloat(inputElement.value);
                        if (inputElement.value.trim() !== '' && (isNaN(value) || value < 0 || value > 4)) {
                           inputElement.classList.add('input-invalid');
                        } else {
                           inputElement.classList.remove('input-invalid');
                        }
                    });
                }
            });
        }
        
        function validateInputs(containerSelector) {
            let allValid = true;
            const container = document.querySelector(containerSelector);
            container.querySelectorAll('input[type="number"], select').forEach(input => {
                input.classList.remove('input-invalid');
                 if (input.closest('.hidden')) return;

                if (input.value.trim() === '' && !input.classList.contains('course-name')) {
                    input.classList.add('input-invalid');
                    allValid = false;
                }
                if (input.id && input.id.includes('gpa')) {
                    const value = parseFloat(input.value);
                     if (input.value.trim() !== '' && (isNaN(value) || value < 0 || value > 4)) {
                        input.classList.add('input-invalid');
                        allValid = false;
                        showToast("المعدل يجب أن يكون بين 0 و 4.", "error");
                    }
                }
            });
            return allValid;
        }

        // --- AI & CHAT FUNCTIONS ---
        async function callGeminiAPI(userMessage) {
            const apiKey = "AIzaSyCiOXNWUZHPXuzgRsFdxPYXsF2QvxdHy1w"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const systemInstruction = "أنت مرشد أكاديمي ذكي وخبير، متخصص في مساعدة طلاب كلية الهندسة بجامعة بنغازي. كن دائماً إيجابياً ومشجعاً، وقدم إجاباتك باللغة العربية بأسلوب واضح وموجز. أكِّد على أهمية مراجعة المصادر الرسمية في الكلية.";
            const payload = { contents: [{ parts: [{ text: userMessage }] }], systemInstruction: { parts: [{ text: systemInstruction }] } };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) return text;
                return "عذراً، لم أتمكن من الحصول على استجابة.";
            } catch (error) {
                console.error("API Call failed:", error);
                throw new Error("حدث خطأ في الاتصال بالمرشد الذكي.");
            }
        }
        
        // --- Static Helper Functions ---
        async function ensureImagesLoaded(container) { const images = Array.from(container.getElementsByTagName("img")); await Promise.all(images.map(img => { if (img.complete) return Promise.resolve(); return new Promise(resolve => { img.onload = img.onerror = resolve; }); }));}
        function showModal(id) { document.getElementById(id).classList.add('show'); document.body.style.overflow = 'hidden'; }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); document.body.style.overflow = 'auto'; }
        function showToast(message, type = 'success') { const t=document.getElementById('toast'),m=document.getElementById('toast-message'); if(!t||!m)return; m.textContent=message; t.style.backgroundColor=type==='error'?'var(--danger-color)':'#2f855a'; t.style.color='white'; t.classList.remove('opacity-0','translate-y-3'); setTimeout(()=>t.classList.add('opacity-0','translate-y-3'),3000); }
        function getGradeOptions(isOld=false){const o=`<option value="4.0">AA (4.0)</option><option value="3.5">A (3.5)</option><option value="3.0">BB (3.0)</option><option value="2.5">B (2.5)</option><option value="2.0">CC (2.0)</option><option value="1.5">C (1.5)</option><option value="1.0">DD (1.0)</option><option value="0.5">D (0.5)</option><option value="0.0">F (0.0)</option>`;return isOld?`<option value="" disabled selected>القديم</option>${o}`:`<option value="" disabled selected>اختر</option>${o}`}
        function getGradeText(v){const g={4.0:'AA',3.5:'A',3.0:'BB',2.5:'B',2.0:'CC',1.5:'C',1.0:'DD',0.5:'D',0.0:'F'};return g[v]||`N/A`}
        function getStaticGPAAdvice(gpa){if(gpa>=3.7)return"أداء استثنائي! أنت في الطليعة.";if(gpa>=3.0)return"عمل رائع! استمر في البناء على هذا النجاح.";if(gpa>=2.0)return"أداء جيد! أنت تسير في الاتجاه الصحيح.";return"لا تستسلم! كل نتيجة هي فرصة للتعلم والنمو."}
        function getSimulationAdvice(req,target,units){if(req>4.0)return`<p class="text-lg text-red-600 dark:text-red-400">للوصول إلى <strong>${target.toFixed(2)}</strong> تحتاج لمتوسط <strong>${req.toFixed(2)}</strong>، وهو <span class="font-bold">غير ممكن</span>.</p>`;if(req<0)return`<p class="text-lg text-green-600 dark:text-green-400">خبر رائع! معدلك الحالي أعلى من الهدف.</p>`;return`<p class="text-lg">لتحقيق هدفك، تحتاج لمتوسط <strong>${req.toFixed(2)}</strong> (<strong>${getGradeText(Math.ceil(req*2)/2)}</strong> أو أعلى) في الـ <strong>${units}</strong> وحدة القادمة.</p>`}
        function setupChat(){appendMessage('أهلاً بك! أنا مرشدك الأكاديمي. اسألني عن أي شيء يخص الدراسة.','advisor')}
        async function handleSendMessage(e){e.preventDefault();const i=document.getElementById('chat-input'),m=i.value.trim();if(!m)return;appendMessage(m,'user');i.value='';showTypingIndicator();try{const r=await callGeminiAPI(m);removeTypingIndicator();appendMessage(r,'advisor')}catch(err){removeTypingIndicator();appendMessage(err.message,'advisor')}}
        function appendMessage(t,s){const c=document.getElementById('chat-messages'),d=document.createElement('div');d.className=`flex items-end gap-2 max-w-[85%] ${s==='user'?'self-end flex-row-reverse':'self-start'}`;const o=s==='advisor'?renderAIContent(t):t.replace(/</g,'&lt;').replace(/>/g,'&gt;');d.innerHTML=`<div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0" style="background-color: var(--card-bg);"><i data-feather="${s==='user'?'user':'cpu'}"></i></div><div class="chat-bubble ${s==='user'?'rounded-br-none':'rounded-bl-none'}" style="background-color: ${s==='user'?'var(--accent-color)':'var(--card-bg)'}; color: ${s==='user'?(document.documentElement.classList.contains('dark')?'#001d35':'white'):'var(--text-primary)'};">${o}</div>`;c.appendChild(d);feather.replace();c.scrollTop=c.scrollHeight}
        function showTypingIndicator(){if(document.getElementById('typing-indicator'))return;const c=document.getElementById('chat-messages'),d=document.createElement('div');d.id='typing-indicator';d.className=`flex items-end gap-2 max-w-[85%] self-start`;d.innerHTML=`<div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0" style="background-color: var(--card-bg);"><i data-feather="cpu"></i></div><div class="chat-bubble rounded-bl-none" style="background-color: var(--card-bg);"><div class="loading-dots"><span></span><span></span><span></span></div></div>`;c.appendChild(d);feather.replace();c.scrollTop=c.scrollHeight}
        function removeTypingIndicator(){const i=document.getElementById('typing-indicator');if(i)i.remove()}
        function renderAIContent(t){let s=t.replace(/</g,'&lt;').replace(/>/g,'&gt;');let h=s.split('\n').map(l=>{l=l.trim().replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>');if(l.startsWith('* ')||l.startsWith('- '))return`<li>${l.substring(2)}</li>`;if(l)return`<p>${l}</p>`;return''}).join('');return h.replace(/<\/li><li>/g,'</li><li>').replace(/<p><\/p>/g,'').replace(/<li>/g,'<ul class="list-disc list-inside space-y-2 my-2"><li>').replace(/<\/li>(?!<li>)/g,'</li></ul>')}
        function addPlanCourse(){planCourseCount++;const c=document.createElement('div');c.id='plan_course_'+planCourseCount;c.className='plan-course-row grid grid-cols-12 gap-3 p-3 rounded-lg border';c.style.borderColor='var(--card-border)';c.innerHTML=`<div class="col-span-8"><input type="text" placeholder="اسم المادة (مثال: رياضيات 1)" class="form-input p-2 plan-course-name"></div><div class="col-span-3"><input type="number" placeholder="الوحدات" min="1" class="form-input p-2 plan-course-units"></div><div class="col-span-1 flex items-center justify-end"><button onclick="removeCourse('plan_course_',${planCourseCount})" class="p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/40" aria-label="حذف المادة"><i data-feather="trash-2" class="text-red-500"></i></button></div>`;document.getElementById('plan_courses_container').appendChild(c);feather.replace();c.scrollIntoView({behavior:'smooth',block:'nearest'})}
        async function generateStudyPlan(){if(!validateInputs('#content-simulation section:last-child'))return;const d=document.getElementById('study_plan_result');d.classList.remove('hidden');d.innerHTML=`<div class="p-4 flex items-center justify-center gap-3"><div class="loading-dots"><span></span><span></span><span></span></div><p>جاري إنشاء الخطة...</p></div>`;let p=[];document.querySelectorAll('#plan_courses_container .plan-course-row').forEach(r=>{const n=r.querySelector('.plan-course-name').value,u=r.querySelector('.plan-course-units').value;if(n&&u)p.push(`- ${n} (${u} وحدات)`)});if(p.length===0){showToast("الرجاء إضافة مادة واحدة على الأقل.","error");d.classList.add('hidden');return}const t=`بصفتك مرشداً أكاديمياً خبيراً لطلاب الهندسة في جامعة بنغازي، قم بإنشاء خطة دراسية استراتيجية. بيانات الطالب: المعدل الحالي ${document.getElementById("sim_current_gpa").value||"غير محدد"}, الساعات المجتازة ${document.getElementById("sim_current_units").value||"غير محدد"}. المواد: ${p.join(", ")}. الخطة يجب أن تتضمن: تحليل للعبء، توزيع ساعات المذاكرة، 3 نصائح، ورسالة تحفيزية.`;try{const s=await callGeminiAPI(t);d.innerHTML=renderAIContent(s)}catch(e){d.textContent='عذراً، حدث خطأ أثناء إنشاء الخطة.'}}

    </script>
</body>
</html>

